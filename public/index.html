<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ClearCycle</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      corePlugins: { preflight: false },
      theme: {
        extend: {
          colors: {
            gtBlue: '#041E42',
            gtBlue2: '#0B2A5B',
            gtGray: '#8A8D8F',
            gtWhite: '#FFFFFF',
            gtMint: '#3AAFA9'
          }
        }
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { width: 100%; min-width: 100%; overflow-x: hidden; }
    body { width: 100%; min-width: 100%; min-height: 100vh; overflow-x: hidden; font-family: 'Inter', system-ui, sans-serif; background: #041E42; margin: 0; padding: 0; }

    .top-band { width: 100%; min-width: 100%; background: linear-gradient(135deg, #041E42, #0B2A5B); border-bottom: 2px solid rgba(138,141,143,0.4); }
    .header-wrap { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; padding: 16px 24px; gap: 16px; }
    .header-left { justify-self: start; }
    .header-center { justify-self: center; text-align: center; }
    .header-right { justify-self: end; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .brand-link { display: inline-flex; align-items: center; gap: 14px; color: white; text-decoration: none; cursor: pointer; position: relative; transition: opacity 0.2s ease, transform 0.2s ease; }
    .brand-link:hover { opacity: 0.9; transform: scale(1.01); }
    .animated-link { position: relative; display: inline-block; }
    .animated-link::after { content: ''; position: absolute; bottom: -2px; left: 0; width: 0; height: 2px; background: #3AAFA9; transition: width 0.3s ease; }
    .animated-link:hover::after { width: 100%; }
    .nav-item { transition: all 0.2s ease, transform 0.15s ease; }
    .nav-item:hover { transform: scale(1.01); }
    .nav-item:active { transform: scale(0.98); }
    .btn-scan-spruce { transition: all 0.2s ease, transform 0.15s ease; }
    .btn-scan-spruce:hover { transform: scale(1.01); }
    .btn-scan-spruce:active { transform: scale(0.98); }
    .profile-dropdown-trigger { transition: all 0.2s ease, transform 0.15s ease; }
    .profile-dropdown-trigger:active { transform: scale(0.98); }
    .brand-center { color: white; text-decoration: none; cursor: pointer; position: relative; transition: opacity 0.2s ease, transform 0.2s ease; }
    .brand-center:hover { opacity: 0.9; transform: scale(1.01); }
    .georgetown-logo { height: 30px; width: auto; flex-shrink: 0; display: block; transition: opacity 0.2s ease, transform 0.2s ease; object-fit: contain; filter: drop-shadow(0 1px 6px rgba(255,255,255,0.12)); }
    .brand-link:hover .georgetown-logo { opacity: 0.9; transform: scale(1.01); }
    .header-center h1 { font-size: clamp(22px, 4vw, 28px); font-weight: 800; color: white; margin: 0; }
    .slogan { font-size: 13px; color: #8A8D8F; margin-top: 2px; }
    .profile-dropdown { position: relative; }
    .profile-dropdown-trigger { display: flex; align-items: center; gap: 8px; background: transparent; border: none; color: white; padding: 8px 12px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
    .profile-dropdown-trigger:hover { background: rgba(255,255,255,0.15); }
    .profile-dropdown.open .profile-dropdown-trigger { background: rgba(255,255,255,0.2); }
    .profile-avatar { width: 28px; height: 28px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .profile-dropdown-menu { position: absolute; top: calc(100% + 8px); right: 0; min-width: 160px; background: #FFFFFF; border: 1px solid #3AAFA9; border-radius: 12px; box-shadow: 0 12px 28px rgba(26,35,65,0.14); padding: 6px 0; z-index: 60; opacity: 0; transform: translateY(-8px); pointer-events: none; transition: opacity 0.15s ease, transform 0.15s ease; }
    .profile-dropdown.open .profile-dropdown-menu { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .profile-dropdown-item { display: block; width: 100%; padding: 10px 16px; border: none; background: none; color: #041E42; font-size: 14px; font-weight: 600; cursor: pointer; text-align: left; text-decoration: none; transition: background 0.15s ease, transform 0.15s ease, opacity 0.2s ease; }
    .profile-dropdown-item:hover { background: rgba(58,175,169,0.12); transform: scale(1.01); }
    .profile-dropdown-item:active { transform: scale(0.98); }
    .profile-dropdown-item.loading { opacity: 0.6; cursor: wait; pointer-events: none; position: relative; }
    .profile-dropdown-item.loading::after { content: ''; position: absolute; right: 16px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; border: 2px solid rgba(58,175,169,0.3); border-top-color: #3AAFA9; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    .pts-badge { background: #3AAFA9; color: white; border: none; border-radius: 10px; padding: 8px 14px; font-weight: 700; font-size: 13px; cursor: default; white-space: nowrap; }
    .g-logo-right { width: 40px; height: 40px; flex-shrink: 0; display: block; }
    .profile-cards-row { display: flex; flex-wrap: wrap; justify-content: center; align-items: stretch; gap: 20px; margin-bottom: 32px; }
    .profile-streak-card, .profile-points-card { background: linear-gradient(135deg, #041E42, #0B2A5B); border-radius: 16px; border-left: 4px solid #3AAFA9; padding: 32px; text-align: center; min-width: 200px; max-width: 280px; flex: 1 1 200px; }
    .profile-streak-card .label, .profile-points-card .label { font-size: 12px; color: rgba(255,255,255,0.8); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
    .profile-streak-card .number, .profile-points-card .number { font-size: 64px; font-weight: 900; color: white; line-height: 1; margin-bottom: 4px; }
    .profile-streak-card .suffix, .profile-points-card .suffix { font-size: 14px; color: rgba(255,255,255,0.9); }
    /* Logged-in Dashboard Card Enhancements */
    #logged-in-home .profile-streak-card, #logged-in-home .profile-points-card { background: rgba(11,42,91,0.6); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; border-left: 2px solid rgba(58,175,169,0.4); padding: 40px 32px; box-shadow: 0 0 0 1px rgba(58,175,169,0.1), 0 8px 24px rgba(0,0,0,0.3); }
    #logged-in-home .profile-streak-card .label, #logged-in-home .profile-points-card .label { font-size: 11px; color: rgba(255,255,255,0.6); text-transform: uppercase; letter-spacing: 0.2em; margin-bottom: 12px; font-weight: 600; }
    #logged-in-home .profile-streak-card .number, #logged-in-home .profile-points-card .number { font-size: 72px; font-weight: 800; color: white; line-height: 1; margin-bottom: 8px; }
    #logged-in-home .profile-streak-card .suffix, #logged-in-home .profile-points-card .suffix { font-size: 14px; color: rgba(255,255,255,0.7); font-weight: 500; }
    .btn-scan-spruce { background: #3AAFA9; color: white; padding: 18px 44px; border-radius: 14px; font-size: 18px; font-weight: 700; border: none; cursor: pointer; transition: all 0.25s ease; width: 100%; }
    .btn-scan-spruce:hover { background: #2E8B8A; transform: translateY(-2px); box-shadow: 0 8px 24px rgba(58,175,169,0.35); }
    .profile-intro { text-align: center; margin-bottom: 24px; }
    .profile-intro h2 { font-size: clamp(20px, 3.5vw, 26px); font-weight: 800; color: #041E42; margin-bottom: 8px; }
    .profile-intro p { font-size: 14px; color: #0B2A5B; line-height: 1.5; }
    .points-tracker-wrap { margin-bottom: 28px; }
    .points-tracker-title { font-size: 14px; font-weight: 700; color: #041E42; text-transform: uppercase; letter-spacing: 0.08em; text-align: center; margin-bottom: 8px; }
    .points-tracker-number { font-size: 32px; font-weight: 900; color: #041E42; text-align: center; margin-bottom: 12px; line-height: 1; }
    #logged-in-home .points-tracker-title { color: rgba(255,255,255,0.9); }
    #logged-in-home .points-tracker-number { color: white; }
    .points-tracker-bar { position: relative; width: 100%; max-width: 560px; margin: 0 auto; height: 44px; background: linear-gradient(180deg, #0B2A5B, #041E42); border-radius: 12px; overflow: visible; box-shadow: 0 4px 16px rgba(26,35,65,0.2); }
    .points-tracker-fill { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 12px 0 0 12px; background: linear-gradient(180deg, #3AAFA9, #2E8B8A); transition: width 0.35s ease; }
    .points-tracker-cap { position: absolute; top: 0; bottom: 0; width: 4px; background: white; border-radius: 2px; transform: translateX(-50%); z-index: 2; box-shadow: 0 0 0 1px rgba(0,0,0,0.1); }
    @media (max-width: 600px) { .points-tracker-number { font-size: 26px; } .points-tracker-bar { height: 36px; } }

    .container { width: 100%; min-width: 100%; overflow-x: hidden; min-height: calc(100vh - 180px); display: block; }
    .main { width: 100%; min-width: 100%; overflow-x: hidden; overflow-y: auto; display: block; }
    .page { display: none; position: relative; }
    .page.active { display: block; }
    
    /* Network Grid Background */
    .animated-grid-bg { pointer-events: none; position: absolute; inset: 0; z-index: 0; overflow: hidden; }
    .grid-base-gradient { position: absolute; inset: 0; background: linear-gradient(180deg, #041E42 0%, #0B2A5B 50%, rgba(0,0,0,0.9) 100%); opacity: 1; }
    .grid-layer { position: absolute; inset: 0; background-image: 
      repeating-linear-gradient(to right, rgba(255,255,255,0.06) 0 1px, transparent 1px 48px),
      repeating-linear-gradient(to bottom, rgba(255,255,255,0.06) 0 1px, transparent 1px 48px);
    filter: blur(0.5px); opacity: 0.5; }
    .grid-node { position: absolute; border-radius: 50%; background: rgba(255,255,255,0.55); filter: blur(0.2px); animation: nodePulse 4s ease-in-out infinite; }
    .grid-node.accent { background: rgba(91,192,235,0.5); }
    .grid-node.accent-mint { background: rgba(58,175,169,0.45); }
    .grid-segment { position: absolute; background: rgba(255,255,255,0.1); pointer-events: none; }
    @keyframes nodePulse { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 0.7; transform: scale(var(--pulse, 1.8)); } }
    @media (max-width: 768px) { .grid-layer { opacity: 0.3; } .grid-node { opacity: 0.6; } }

    .title-page { min-height: 100vh; width: 100%; min-width: 100%; padding: 48px 24px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; text-align: center; background: transparent; box-sizing: border-box; position: relative; overflow: hidden; }
    .title-page::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: 
      radial-gradient(circle at 30% 20%, rgba(58,175,169,0.08) 0%, transparent 40%),
      radial-gradient(circle at 70% 80%, rgba(58,175,169,0.06) 0%, transparent 40%);
    z-index: 0; }
    .title-page::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: 
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(58,175,169,0.03) 2px, rgba(58,175,169,0.03) 4px),
      repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(58,175,169,0.02) 2px, rgba(58,175,169,0.02) 4px),
      linear-gradient(45deg, rgba(58,175,169,0.05) 0%, transparent 50%, rgba(58,175,169,0.05) 100%);
    opacity: 0.06; z-index: 0; animation: gradientMove 18s linear infinite; pointer-events: none; }
    .title-page > * { position: relative; z-index: 1; }
    .title-page-name { font-size: clamp(40px, 8vw, 56px); color: white; font-weight: 800; margin-bottom: 28px; }
    .scan-cta-main, .title-page-scan { background: white; color: #041E42; padding: 18px 44px; border-radius: 14px; font-size: 18px; font-weight: 700; border: none; cursor: pointer; transition: all 0.25s ease, transform 0.15s ease; }
    .scan-cta-main:hover, .title-page-scan:hover { transform: translateY(-2px) scale(1.01); box-shadow: 0 8px 24px rgba(0,0,0,0.2); }
    .scan-cta-main:active, .title-page-scan:active { transform: translateY(0) scale(0.98); }
    .title-page-slogan { margin-top: 20px; color: #8A8D8F; }
    .scan-button-note { margin-top: 12px; font-size: 13px; color: #8A8D8F; text-align: center; }
    .landing-hero { min-height: 100vh; width: 100%; min-width: 100%; padding: 80px 24px 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: transparent; box-sizing: border-box; position: relative; overflow: hidden; }
    .landing-hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: 
      radial-gradient(circle at 30% 20%, rgba(58,175,169,0.08) 0%, transparent 40%),
      radial-gradient(circle at 70% 80%, rgba(58,175,169,0.06) 0%, transparent 40%);
    z-index: 0; }
    .landing-hero::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: 
      repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(58,175,169,0.03) 2px, rgba(58,175,169,0.03) 4px),
      repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(58,175,169,0.02) 2px, rgba(58,175,169,0.02) 4px),
      linear-gradient(45deg, rgba(58,175,169,0.05) 0%, transparent 50%, rgba(58,175,169,0.05) 100%);
    opacity: 0.06; z-index: 0; animation: gradientMove 18s linear infinite; pointer-events: none; }
    @keyframes gradientMove { 0% { transform: translate(0, 0) rotate(0deg); } 100% { transform: translate(50px, 50px) rotate(360deg); } }
    .landing-hero > * { position: relative; z-index: 1; }
    .landing-title-wrapper { position: relative; margin-bottom: 24px; }
    .landing-title-glow { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; background: radial-gradient(circle, rgba(58,175,169,0.4), transparent 70%); border-radius: 50%; filter: blur(40px); z-index: 0; animation: pulseGlow 3s ease-in-out infinite; }
    @keyframes pulseGlow { 0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); } 50% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.2); } }
    .landing-title { font-size: clamp(48px, 8vw, 64px); color: white; font-weight: 800; margin-bottom: 16px; position: relative; z-index: 1; }
    .landing-subtitle { font-size: clamp(18px, 3vw, 24px); color: #8A8D8F; margin-bottom: 40px; font-weight: 600; }
    .landing-bullets { list-style: none; padding: 0; margin: 0 0 48px; max-width: 600px; text-align: left; }
    .landing-bullets li { color: white; font-size: 16px; line-height: 1.8; margin-bottom: 16px; padding-left: 32px; position: relative; }
    .landing-bullets li::before { content: '‚úì'; position: absolute; left: 0; color: #3AAFA9; font-weight: 700; font-size: 20px; }
    .how-it-works { width: 100%; min-width: 100%; padding: 80px 24px; background: #f8fafc; text-align: center; box-sizing: border-box; }
    .how-it-works-title { font-size: clamp(32px, 5vw, 42px); margin-bottom: 48px; font-weight: 800; color: #041E42; }
    .how-it-works-cards { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 32px; max-width: 1200px; margin: 0 auto; padding: 0 12px; }
    .how-it-works-card { background: white; border-radius: 20px; padding: 40px 28px; border: 2px solid #3AAFA9; transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 16px rgba(4,30,66,0.08); }
    .how-it-works-card:hover { transform: translateY(-8px); box-shadow: 0 12px 32px rgba(4,30,66,0.15); }
    .how-it-works-card-icon { font-size: 48px; margin-bottom: 20px; }
    .how-it-works-card-title { font-size: 24px; font-weight: 700; color: #041E42; margin-bottom: 12px; }
    .how-it-works-card-text { font-size: 15px; color: #0B2A5B; line-height: 1.6; }
    @media (max-width: 900px) { .how-it-works-cards { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .how-it-works-cards { grid-template-columns: 1fr; } .landing-bullets { text-align: center; } .landing-bullets li { padding-left: 0; padding-top: 24px; } .landing-bullets li::before { top: 0; left: 50%; transform: translateX(-50%); } }

    .why-clearcycle { width: 100%; min-width: 100%; padding: 56px 24px; background: #f8fafc; text-align: center; box-sizing: border-box; }
    .why-heading { font-size: clamp(26px, 4vw, 34px); margin-bottom: 36px; font-weight: 800; color: #041E42; }
    .why-boxes { display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 24px; max-width: 1100px; margin: 0 auto; padding: 0 12px; }
    .why-box { background: #fff; border-radius: 18px; padding: 26px 22px; border: 2px solid #3AAFA9; transition: transform 0.25s ease, box-shadow 0.25s ease; }
    .why-box:hover { transform: translateY(-6px); box-shadow: 0 14px 32px rgba(26,35,65,0.15); }
    .why-box-icon { font-size: 28px; margin-bottom: 10px; }
    .why-box-text { font-size: 14px; color: #0B2A5B; line-height: 1.5; }
    @media (max-width: 900px) { .why-boxes { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 600px) { .why-boxes { grid-template-columns: 1fr; } }
    @media (max-width: 768px) {
      .header-wrap { grid-template-columns: 1fr; text-align: center; }
      .header-left, .header-center, .header-right { justify-self: center; }
      .header-right { flex-wrap: wrap; justify-content: center; }
    }

    .scan-content, .redeem-content { max-width: 600px; margin: 0 auto; padding: 24px; }
    .camera-preview { width: 100%; aspect-ratio: 4/3; background: #111; border-radius: 14px; margin-bottom: 24px; overflow: hidden; }
    .camera-preview video { width: 100%; height: 100%; object-fit: cover; }
    .status-text { text-align: center; margin-bottom: 24px; font-size: 15px; color: #041E42; font-weight: 500; }
    .scan-btn { width: 100%; padding: 18px; background: #3AAFA9; color: white; border: none; border-radius: 14px; font-weight: 700; font-size: 17px; cursor: pointer; transition: all 0.25s ease, transform 0.15s ease; }
    .scan-btn:hover:not(:disabled) { background: #2E8B8A; transform: translateY(-1px) scale(1.01); }
    .scan-btn:active:not(:disabled) { transform: translateY(0) scale(0.98); }
    .scan-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .scan-steps { background: #FFFFFF; padding: 24px; border-radius: 14px; border: 2px solid #3AAFA9; margin-top: 24px; }
    .step-item { display: flex; gap: 12px; margin-bottom: 12px; font-size: 14px; color: #041E42; }
    .step-dot { width: 10px; height: 10px; background: #3AAFA9; border-radius: 50%; flex-shrink: 0; margin-top: 4px; }

    .points-box { background: #FFFFFF; padding: 32px; border-radius: 16px; text-align: center; margin-bottom: 24px; border: 2px solid #3AAFA9; }
    .points-number { font-size: 48px; font-weight: 900; color: #041E42; }
    .points-label { font-size: 13px; color: #0B2A5B; }
    /* Rewards Dashboard Styles */
    .rewards-panel { margin: 40px auto 0; width: 100%; max-width: 80rem; padding: 0 24px; }
    .rewards-panel-inner { border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); backdrop-filter: blur(16px); padding: 32px; box-shadow: 0 24px 90px rgba(0,0,0,0.5); }
    .rewards-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; flex-wrap: wrap; gap: 16px; }
    .rewards-title { font-size: clamp(28px, 4vw, 36px); font-weight: 800; color: white; margin: 0; }
    .rewards-subtitle { font-size: 15px; color: rgba(255,255,255,0.8); margin-top: 8px; }
    .rewards-points-badge { display: inline-block; border-radius: 9999px; background: rgba(255,255,255,0.1); padding: 6px 12px; font-size: 14px; color: rgba(255,255,255,0.8); font-weight: 600; }
    .reward-track-section { margin-bottom: 48px; }
    .reward-track-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 24px; flex-wrap: wrap; gap: 8px; }
    .reward-track-title { font-size: 22px; font-weight: 700; color: white; margin: 0; }
    .reward-track-helper { font-size: 13px; color: rgba(255,255,255,0.6); }
    .reward-track-bar { position: relative; width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 32px; overflow: visible; }
    .reward-track-fill { position: absolute; left: 0; top: 0; bottom: 0; border-radius: 4px; background: rgba(58,175,169,0.8); box-shadow: 0 0 22px rgba(58,175,169,0.25); transition: width 0.4s ease; }
    .reward-milestones { display: flex; justify-content: space-between; position: relative; margin-top: 24px; }
    .reward-milestone { position: relative; flex: 1; text-align: center; }
    .reward-milestone-node { width: 20px; height: 20px; border-radius: 50%; margin: 0 auto 12px; position: relative; z-index: 2; }
    .reward-milestone-node.completed { background: #3AAFA9; box-shadow: 0 0 0 4px rgba(58,175,169,0.3); }
    .reward-milestone-node.upcoming { background: rgba(255,255,255,0.3); }
    .reward-milestone-label { font-size: 12px; color: rgba(255,255,255,0.7); font-weight: 500; }
    .reward-milestone-points { font-size: 11px; color: rgba(255,255,255,0.5); margin-top: 4px; }
    .claim-rewards-section { margin-top: 48px; }
    .claim-rewards-title { font-size: 22px; font-weight: 700; color: white; margin-bottom: 24px; }
    .claim-rewards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
    .claim-reward-card { background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 24px; }
    .claim-reward-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
    .claim-reward-title { font-size: 18px; font-weight: 700; color: white; margin: 0; }
    .claim-reward-cost { display: inline-block; background: rgba(58,175,169,0.2); color: #8FE7DE; padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: 700; }
    .claim-reward-desc { font-size: 14px; color: rgba(255,255,255,0.7); line-height: 1.5; margin-bottom: 16px; }
    .claim-reward-btn { width: 100%; padding: 12px; border: none; border-radius: 10px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s ease; }
    .claim-reward-btn.enabled { background: white; color: #041E42; }
    .claim-reward-btn.enabled:hover { background: rgba(255,255,255,0.9); }
    .claim-reward-btn.disabled { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.4); cursor: not-allowed; }
    .rewards-home-btn { background: white; color: #041E42; padding: 14px 32px; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease; }
    .rewards-home-btn:hover { background: rgba(255,255,255,0.9); transform: translateY(-1px); }
    .rewards-home-btn:active { transform: translateY(0); }
    @media (max-width: 768px) { .rewards-panel-inner { padding: 24px; } .reward-milestones { flex-direction: column; gap: 24px; } .reward-milestone { text-align: left; } .claim-rewards-grid { grid-template-columns: 1fr; } }
    .rewards-timeline { position: relative; max-width: 42rem; margin: 0 auto; padding: 0 24px 0 32px; }
    .rewards-timeline::before { content: ''; position: absolute; left: 20px; top: 0; bottom: 0; width: 3px; background: linear-gradient(180deg, rgba(58,175,169,0.3) 0%, rgba(58,175,169,0.5) 50%, rgba(58,175,169,0.3) 100%); border-radius: 2px; box-shadow: 0 0 12px rgba(58,175,169,0.2); }
    .timeline-item { position: relative; margin-bottom: 40px; padding-left: 56px; opacity: 0; transform: translateY(6px); animation: timelineFadeIn 0.4s ease-out forwards; }
    .timeline-item:last-child { margin-bottom: 0; }
    .timeline-item:nth-child(1) { animation-delay: 0.1s; }
    .timeline-item:nth-child(2) { animation-delay: 0.2s; }
    .timeline-item:nth-child(3) { animation-delay: 0.3s; }
    .timeline-item:nth-child(4) { animation-delay: 0.4s; }
    .timeline-item:nth-child(5) { animation-delay: 0.5s; }
    @keyframes timelineFadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes typewriter { from { width: 0; } to { width: var(--tw-width, 20ch); } }
    @keyframes caret { 0%, 50% { border-color: rgba(255,255,255,0.7); } 51%, 100% { border-color: transparent; } }
    .typewriter { display: inline-block; overflow: hidden; white-space: nowrap; border-right: 2px solid rgba(255,255,255,0.7); width: 0; animation: typewriter 1.1s steps(var(--chars, 20)) forwards, caret 0.9s steps(1) infinite; animation-delay: 0.3s, 0s; }
    @media (max-width: 420px) { .typewriter { white-space: normal; width: auto; border-right: none; animation: none; } }
    .timeline-dot { position: absolute; left: 10px; top: 6px; width: 20px; height: 20px; border-radius: 50%; background: rgba(11,42,91,0.8); border: 3px solid rgba(58,175,169,0.8); box-shadow: 0 0 0 4px rgba(58,175,169,0.15), 0 0 16px rgba(58,175,169,0.4), inset 0 0 8px rgba(58,175,169,0.2); z-index: 2; }
    .timeline-dot::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 8px; height: 8px; border-radius: 50%; background: rgba(58,175,169,0.9); box-shadow: 0 0 8px rgba(58,175,169,0.6); }
    .timeline-card { background: rgba(11,42,91,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(4px); box-shadow: 0 4px 16px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.1); }
    .timeline-points-badge { display: inline-block; background: rgba(58,175,169,0.15); color: #8FE7DE; padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 700; margin-bottom: 8px; }
    .timeline-title { font-size: 18px; font-weight: 700; color: white; margin-bottom: 6px; }
    .timeline-desc { font-size: 14px; color: rgba(255,255,255,0.8); line-height: 1.5; }
    @media (max-width: 640px) { .rewards-timeline { padding: 0 16px 0 24px; } .rewards-timeline::before { left: 12px; width: 2px; } .timeline-item { padding-left: 44px; margin-bottom: 32px; } .timeline-dot { left: 4px; width: 16px; height: 16px; border-width: 2px; } .timeline-dot::after { width: 6px; height: 6px; } .timeline-card { padding: 16px; } }
    .home-title { font-size: clamp(22px, 3.5vw, 28px); font-weight: 800; color: #041E42; margin-bottom: 12px; }
    .home-subtitle { font-size: 14px; color: #0B2A5B; line-height: 1.5; margin-bottom: 20px; }
    #rewards-logged-out .home-title { color: white; }
    #rewards-logged-out .home-subtitle { color: rgba(255,255,255,0.8); }

    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
    .modal.show { display: flex; }
    .modal-box { background: white; padding: 28px 32px; border-radius: 16px; max-width: 440px; width: 100%; box-shadow: 0 20px 56px rgba(0,0,0,0.2); }
    .modal-title { font-size: 22px; font-weight: 700; margin-bottom: 12px; color: #041E42; }
    .modal-text { color: #0B2A5B; margin-bottom: 20px; font-size: 14px; line-height: 1.5; }
    .modal-input { width: 100%; padding: 12px 14px; margin-bottom: 12px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; }
    .modal-input:focus { outline: none; border-color: #3AAFA9; box-shadow: 0 0 0 3px rgba(58,175,169,0.15); }
    .modal-buttons { display: flex; gap: 12px; }
    .modal-btn { flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.2s ease, transform 0.15s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    .modal-confirm { background: #3AAFA9; color: white; box-shadow: 0 4px 12px rgba(58,175,169,0.3); }
    .modal-confirm:hover { background: #2E8B8A; transform: translateY(-1px) scale(1.01); box-shadow: 0 6px 16px rgba(58,175,169,0.4); }
    .modal-confirm:active { transform: translateY(0) scale(0.98); box-shadow: 0 2px 6px rgba(58,175,169,0.3); }
    .modal-cancel { background: #f3f4f6; color: #041E42; border: 2px solid #d1d5db; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .modal-cancel:hover { background: #e5e7eb; border-color: #9ca3af; transform: translateY(-1px) scale(1.01); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
    .modal-cancel:active { transform: translateY(0) scale(0.98); box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

    .product-modal-box { background: white; padding: 28px 32px; border-radius: 20px; max-width: 420px; width: 100%; box-shadow: 0 20px 56px rgba(0,0,0,0.3); text-align: center; }
    .product-modal-title { font-size: 20px; font-weight: 800; color: #041E42; margin-bottom: 16px; line-height: 1.3; }
    .product-modal-img-wrap { margin-bottom: 16px; min-height: 120px; display: flex; align-items: center; justify-content: center; }
    .product-modal-img { max-width: 160px; max-height: 160px; object-fit: contain; border-radius: 12px; }
    .product-modal-brand { font-size: 16px; font-weight: 600; color: #041E42; margin-bottom: 12px; }
    .product-modal-desc { background: #f5f5f5; color: #041E42; font-size: 13px; line-height: 1.6; padding: 16px 18px; border-radius: 12px; margin-bottom: 24px; text-align: left; }
    .product-modal-btns { display: flex; gap: 12px; }
    .product-modal-btn-yes { flex: 1; padding: 14px 20px; background: #3AAFA9; color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease, transform 0.15s ease; }
    .product-modal-btn-yes:hover { background: #2E8B8A; transform: translateY(-1px) scale(1.01); }
    .product-modal-btn-yes:active { transform: translateY(0) scale(0.98); }
    .product-modal-btn-no { flex: 1; padding: 14px 20px; background: #e5e7eb; color: #041E42; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease, transform 0.15s ease; }
    .product-modal-btn-no:hover { background: #d1d5db; transform: scale(1.01); }
    .product-modal-btn-no:active { transform: scale(0.98); }

    footer { width: 100%; min-width: 100%; padding: 32px 24px; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 24px; background: linear-gradient(180deg, #041E42 0%, #0B2A5B 100%); border-top: 2px solid rgba(58,175,169,0.3); box-sizing: border-box; position: relative; }
    footer::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(58,175,169,0.5), transparent); }
    .footer-credits { font-size: 13px; color: rgba(255,255,255,0.8); text-align: center; }
    .footer-btn { background: #3AAFA9; color: white; padding: 14px 32px; border: none; border-radius: 12px; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.25s ease; }
    .footer-btn:hover { background: #2E8B8A; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(58,175,169,0.3); }

    #loginDropdown { display: none; position: absolute; top: 100%; right: 0; margin-top: 8px; min-width: 140px; background: #FFFFFF; border: 1px solid #3AAFA9; border-radius: 12px; box-shadow: 0 12px 28px rgba(26,35,65,0.14); padding: 6px 0; z-index: 60; }
    #loginDropdown.open { display: block; }
    #loginDropdown button { display: block; width: 100%; padding: 10px 16px; border: none; background: none; color: #041E42; font-size: 13px; font-weight: 600; cursor: pointer; text-align: left; }
    #loginDropdown button:hover { background: rgba(58,175,169,0.12); }
    .login-wrap { position: relative; }
  </style>
</head>
<body>

  <div class="top-band">
    <div class="header-wrap">
      <div class="header-left">
        <a class="brand-link animated-link" href="#" onclick="switchTab('home'); return false;" aria-label="Home">
          <img src="assets/georgetown-wordmark.svg" alt="Georgetown University" class="georgetown-logo" onerror="this.onerror=null; this.src='assets/georgetown-wordmark.png';" />
        </a>
      </div>
      <div class="header-center">
        <a class="brand-center animated-link" href="#" onclick="switchTab('home'); return false;">
          <h1>ClearCycle</h1>
          <p class="slogan">Scan. Verify. Reward.</p>
        </a>
      </div>
      <nav class="header-right">
        <div class="profile-dropdown" id="profileDropdown">
          <button type="button" class="profile-dropdown-trigger" onclick="toggleProfileDropdown(event)" aria-label="Profile menu">
            <div class="profile-avatar">üë§</div>
            <span id="profileDropdownText">Profile</span>
          </button>
          <div class="profile-dropdown-menu">
            <button type="button" class="profile-dropdown-item" id="profileDropdownLogin" onclick="handleProfileMenuClick('login')">Log in</button>
            <button type="button" class="profile-dropdown-item" id="profileDropdownLogout" onclick="handleProfileMenuClick('logout')" style="display: none;">Sign out</button>
            <button type="button" class="profile-dropdown-item" id="profileDropdownRewards" onclick="handleProfileMenuClick('rewards')">Rewards</button>
          </div>
        </div>
      </nav>
    </div>
  </div>

  <div class="container">
    <main class="main">
      <div class="page active" id="page-home">
        <!-- Network Grid Background -->
        <div class="animated-grid-bg" id="networkGridBg">
          <div class="grid-base-gradient"></div>
          <div class="grid-layer"></div>
          <!-- Nodes and segments will be generated by JavaScript -->
        </div>
        <!-- Logged-out Landing Page -->
        <div id="landing-page" style="display: none; position: relative; z-index: 1;">
          <section class="landing-hero">
            <div class="landing-title-wrapper">
              <div class="landing-title-glow"></div>
              <h1 class="landing-title">ClearCycle</h1>
            </div>
            <p class="landing-subtitle">Scan. Verify. Reward.</p>
            <ul class="landing-bullets">
              <li>Scan a product barcode to identify recyclable items</li>
              <li>Scan the bin QR code to verify your location</li>
              <li>Record a quick video for verification and earn rewards</li>
            </ul>
            <button type="button" class="scan-cta-main title-page-scan" onclick="handleScanClick()">Scan</button>
            <p class="scan-button-note">Log in to start scanning and earning rewards.</p>
          </section>
          <section class="how-it-works">
            <h2 class="how-it-works-title">How It Works</h2>
            <div class="how-it-works-cards">
              <div class="how-it-works-card">
                <div class="how-it-works-card-icon">üì±</div>
                <h3 class="how-it-works-card-title">Scan</h3>
                <p class="how-it-works-card-text">Use your phone's camera to scan product barcodes and identify recyclable items instantly.</p>
              </div>
              <div class="how-it-works-card">
                <div class="how-it-works-card-icon">‚úÖ</div>
                <h3 class="how-it-works-card-title">Verify</h3>
                <p class="how-it-works-card-text">Scan the bin QR code and record a quick video to verify your recycling action.</p>
              </div>
              <div class="how-it-works-card">
                <div class="how-it-works-card-icon">üéÅ</div>
                <h3 class="how-it-works-card-title">Reward</h3>
                <p class="how-it-works-card-text">Earn points for every verified recycling action and redeem them for dining credits.</p>
              </div>
            </div>
          </section>
        </div>
        <!-- Logged-in Home Page -->
        <div id="logged-in-home" style="display: none; position: relative; z-index: 1;">
          <section class="title-page">
            <div class="mx-auto mt-12 w-full max-w-4xl px-6">
              <div class="relative rounded-3xl border border-white/10 bg-white/5 backdrop-blur-xl shadow-[0_20px_80px_rgba(0,0,0,0.45)] p-8 md:p-10">
                <div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
                <h1 class="title-page-name">ClearCycle</h1>
                <p class="title-page-slogan"><span class="typewriter" style="--chars: 20; --tw-width: 20ch;">Scan. Verify. Reward.</span></p>
                
                <!-- Dashboard: Streak + Points Cards -->
                <div class="profile-cards-row" style="margin-top: 32px; margin-bottom: 32px;">
                  <div class="profile-streak-card">
                    <div class="label">Current Streak</div>
                    <div class="number" id="homeStreakDays">0</div>
                    <div class="suffix">days in a row</div>
                  </div>
                  <div class="profile-points-card">
                    <div class="label">Points</div>
                    <div class="number" id="homePointsDisplay">0</div>
                    <div class="suffix">pts</div>
                  </div>
                </div>
                
                <!-- Points Tracker -->
                <div class="points-tracker-wrap">
                  <div class="points-tracker-title">Points Tracker</div>
                  <div class="points-tracker-number" id="homeTrackerPointsNumber">0</div>
                  <div class="points-tracker-bar" id="homePointsTrackerBar">
                    <div class="points-tracker-fill" id="homePointsTrackerFill"></div>
                    <div class="points-tracker-cap" id="homePointsTrackerCap"></div>
                  </div>
                </div>
                
                <!-- CTA: Start Scanning -->
                <button type="button" class="btn-scan-spruce" onclick="switchTab('scan')" style="margin-top: 32px;">Start Scanning</button>
              </div>
            </div>
          </section>
        </div>
      </div>

      <div class="page" id="page-scan">
        <div class="scan-content">
          <div class="camera-preview"><video id="video" playsinline muted autoplay></video></div>
          <div class="status-text" id="status">Ready to scan</div>
          <button type="button" class="scan-btn" id="scanBtn" onclick="startScan()">Scan</button>
          <div class="scan-steps">
            <div class="step-item"><span class="step-dot"></span><span id="step1">1. Scan product barcode</span></div>
            <div class="step-item"><span class="step-dot"></span><span id="step2">2. Scan trash can QR code</span></div>
            <div class="step-item"><span class="step-dot"></span><span id="step3">3. Record 5-second video</span></div>
          </div>
        </div>
      </div>

      <div class="page" id="page-redeem">
        <!-- Logged-in Rewards View -->
        <div id="rewards-logged-in" style="display: none; background: linear-gradient(180deg, #041E42 0%, #0B2A5B 50%, rgba(0,0,0,0.9) 100%); min-height: 100vh; padding: 60px 0;">
          <div class="rewards-panel">
            <div class="rewards-panel-inner">
              <!-- Header -->
              <div class="rewards-header">
                <div>
                  <h2 class="rewards-title">Rewards</h2>
                  <p class="rewards-subtitle">Track your progress and claim perks.</p>
                </div>
                <span class="rewards-points-badge" id="rewardsPointsBadge">0 pts</span>
              </div>
              
              <!-- Reward Track Section -->
              <div class="reward-track-section">
                <div class="reward-track-header">
                  <h3 class="reward-track-title">Reward Track</h3>
                  <p class="reward-track-helper">Earn 20 pts per verified recycle.</p>
                </div>
                <div class="reward-track-bar">
                  <div class="reward-track-fill" id="rewardTrackFill" style="width: 0%;"></div>
                </div>
                <div class="reward-milestones" id="rewardMilestones">
                  <!-- Milestones will be generated by JavaScript -->
                </div>
              </div>
              
              <!-- Claim Rewards Section -->
              <div class="claim-rewards-section">
                <h3 class="claim-rewards-title">Claim Rewards</h3>
                <div class="claim-rewards-grid" id="claimRewardsGrid">
                  <!-- Reward cards will be generated by JavaScript -->
                </div>
              </div>
              
              <!-- Navigation Button -->
              <div style="margin-top: 48px; text-align: center;">
                <button type="button" class="rewards-home-btn" onclick="switchTab('home')">
                  Back to Home
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- Logged-out Rewards Preview -->
        <div id="rewards-logged-out" style="display: none; background: linear-gradient(180deg, #041E42 0%, #0B2A5B 50%, rgba(0,0,0,0.9) 100%); min-height: 100vh; padding: 60px 0;">
          <div class="redeem-content" style="max-width: 42rem;">
            <h2 class="home-title" style="text-align: center; margin-bottom: 8px;">Rewards Preview</h2>
            <p class="home-subtitle" style="text-align: center; margin-bottom: 40px;">Earn points by scanning items and verifying disposal.</p>
            
            <div class="rewards-timeline">
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-card">
                  <div class="timeline-points-badge">50 pts</div>
                  <div class="timeline-title">Free coffee coupon</div>
                  <div class="timeline-desc">Redeem for a free coffee at campus cafes.</div>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-card">
                  <div class="timeline-points-badge">100 pts</div>
                  <div class="timeline-title">Campus store discount</div>
                  <div class="timeline-desc">Get 15% off at the Georgetown bookstore.</div>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-card">
                  <div class="timeline-points-badge">200 pts</div>
                  <div class="timeline-title">Dining credit raffle entry</div>
                  <div class="timeline-desc">Enter to win dining hall credits and meal swipes.</div>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-card">
                  <div class="timeline-points-badge">350 pts</div>
                  <div class="timeline-title">Sustainable merch drop</div>
                  <div class="timeline-desc">Exclusive eco-friendly Georgetown merchandise.</div>
                </div>
              </div>
              <div class="timeline-item">
                <div class="timeline-dot"></div>
                <div class="timeline-card">
                  <div class="timeline-points-badge">500 pts</div>
                  <div class="timeline-title">Priority rewards / sponsor perk</div>
                  <div class="timeline-desc">Access to premium rewards and special sponsor benefits.</div>
                </div>
              </div>
            </div>
            
            <div style="text-align: center; margin-top: 48px;">
              <button type="button" class="scan-cta-main title-page-scan" onclick="handleProfileMenuClick('login')" style="margin-bottom: 16px;">Log in to start earning</button>
              <p style="font-size: 13px; color: rgba(255,255,255,0.7); margin: 0;">
                <a href="#" onclick="switchTab('home'); return false;" style="color: rgba(58,175,169,0.9); text-decoration: underline;">How scoring works</a>
              </p>
            </div>
          </div>
        </div>
      </div>

      <div class="page" id="page-profile">
        <div class="redeem-content" style="max-width:700px;">
          <div class="profile-cards-row">
            <div class="profile-streak-card">
              <div class="label">Current Streak</div>
              <div class="number" id="profileStreakDays">0</div>
              <div class="suffix">days in a row</div>
            </div>
            <div class="profile-points-card">
              <div class="label">Points</div>
              <div class="number" id="profilePointsDisplay">0</div>
              <div class="suffix">pts</div>
            </div>
          </div>
          <div class="profile-intro">
            <h2>Scan. Verify. Reward.</h2>
            <p>Every item you recycle earns 20 points. 100 points = $1 dining credit.</p>
          </div>
          <div class="points-tracker-wrap">
            <div class="points-tracker-title">Points Tracker</div>
            <div class="points-tracker-number" id="trackerPointsNumber">0</div>
            <div class="points-tracker-bar" id="pointsTrackerBar">
              <div class="points-tracker-fill" id="pointsTrackerFill"></div>
              <div class="points-tracker-cap" id="pointsTrackerCap"></div>
            </div>
          </div>
          <button type="button" class="btn-scan-spruce" onclick="switchTab('scan')">Start Scanning</button>
          <button type="button" class="nav-item" id="profileLoginBtn" onclick="toggleProfileOrLogin()" style="width:100%; margin-top:20px; background:transparent; border:2px solid #3AAFA9; color:#3AAFA9;">Log in</button>
        </div>
      </div>

      <div class="page" id="page-settings">
        <div class="redeem-content">
          <h2 class="home-title">Settings</h2>
          <p class="home-subtitle">Account and app info.</p>
          <button type="button" class="nav-item" onclick="toggleProfileOrLogin()" style="width:100%; margin-bottom:12px;">Account / Log in</button>
          <p style="font-size:13px; color:#0B2A5B; margin-bottom:16px;">ClearCycle ‚Äî Scan. Verify. Reward Sustainability.</p>
          <button type="button" class="nav-item" onclick="logout()" style="width:100%; background:#041E42;">Log out</button>
        </div>
      </div>

      <div class="page" id="page-admin">
        <div class="redeem-content" style="max-width:800px;">
          <h2 class="home-title" style="color:#041E42; font-size:28px; font-weight:800; margin-bottom:32px;">Admin: Trash Cans</h2>
          <div id="adminAuthRequired" style="display:none; padding:20px; background:#fef3c7; border:2px solid #f59e0b; border-radius:12px; margin-bottom:24px; text-align:center;">
            <p style="margin:0; color:#041E42; font-weight:600;">Admin access required. <button type="button" onclick="showLoginModal()" style="background:none; border:none; color:#3AAFA9; text-decoration:underline; cursor:pointer; font-weight:700;">Log in</button> as admin.</p>
          </div>
          <div id="adminPanel" style="display:none;">
            <div style="background:white; padding:28px; border-radius:16px; box-shadow:0 4px 16px rgba(0,0,0,0.1); margin-bottom:32px;">
              <h3 style="color:#041E42; font-size:20px; font-weight:700; margin-bottom:20px;">Create New Trash Can</h3>
              <div style="display:flex; flex-direction:column; gap:16px;">
                <input type="text" id="adminCanId" placeholder="Can ID (e.g., TC001)" style="padding:12px 16px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; color:#041E42;" />
                <input type="text" id="adminCanLabel" placeholder="Label (e.g., Alderman 1st Floor)" style="padding:12px 16px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; color:#041E42;" />
                <input type="text" id="adminCanLocation" placeholder="Location (optional)" style="padding:12px 16px; border:1px solid #d1d5db; border-radius:10px; font-size:14px; color:#041E42;" />
                <button type="button" onclick="createTrashCan()" style="padding:12px 24px; background:#3AAFA9; color:white; border:none; border-radius:10px; font-weight:700; font-size:15px; cursor:pointer; transition:all 0.2s ease;">Create Can</button>
              </div>
            </div>
            <div>
              <h3 style="color:#041E42; font-size:20px; font-weight:700; margin-bottom:20px;">All Trash Cans</h3>
              <div id="adminTrashCansList" style="display:flex; flex-direction:column; gap:12px;">
                <p style="color:#64748b; font-size:14px;">Loading trash cans...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <footer>
    <button type="button" class="footer-btn" onclick="alert('Contact us at hello@clearcycle.app')">Contact Us</button>
    <span class="footer-credits">Built for Hoya Hacks 2026 @ Georgetown University</span>
  </footer>

  <div class="modal" id="productConfirmModal">
    <div class="product-modal-box" style="max-width: 500px;">
      <!-- Product Title Section -->
      <div style="text-align: center; margin-bottom: 20px;">
        <h2 id="productModalTitle" style="font-size: 24px; font-weight: 800; color: #041E42; margin: 0 0 6px 0;">Product</h2>
        <p id="productModalBrand" style="font-size: 14px; color: #8A8D8F; margin: 0; font-weight: 500;"></p>
      </div>
      
      <!-- Product Image -->
      <div style="text-align: center; margin-bottom: 24px; display: flex; justify-content: center; align-items: center;">
        <img class="product-modal-img" id="productModalImg" src="" alt="" style="display:none; max-width: 280px; width: 100%; height: auto; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); object-fit: contain; margin: 0 auto;" />
      </div>
      
      <!-- Product Details Card -->
      <div id="productModalDetailsCard" style="background: rgba(255,255,255,0.9); border-radius: 16px; padding: 24px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); max-width: 420px; margin: 0 auto 20px; text-align: left;">
        <div id="productModalBrandRow" style="margin-bottom: 16px;">
          <div style="font-size: 12px; font-weight: 600; color: #8A8D8F; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 4px;">Brand</div>
          <div id="productModalBrandValue" style="font-size: 16px; color: #041E42; font-weight: 500;"></div>
        </div>
        <div id="productModalCategoryRow">
          <div style="font-size: 12px; font-weight: 600; color: #8A8D8F; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px;">Category</div>
          <div id="productModalCategoryValue" style="font-size: 14px; color: #041E42;"></div>
        </div>
      </div>
      
      <!-- Recyclability Message -->
      <div id="productModalRecyclability" style="margin: 0 auto 20px; padding: 12px 16px; border-radius: 10px; font-size: 13px; line-height: 1.5; display: none; max-width: 420px;"></div>
      
      <!-- Action Buttons -->
      <div class="product-modal-btns">
        <button type="button" class="product-modal-btn-yes" id="productModalYes" onclick="confirmProductYes()">Yes</button>
        <button type="button" class="product-modal-btn-no" id="productModalNo" onclick="confirmProductNo()">No</button>
      </div>
    </div>
  </div>

  <div class="modal" id="trashCanConfirmModal">
    <div class="product-modal-box">
      <div class="product-modal-title" id="trashCanModalTitle" style="color:#041E42; font-size:20px; font-weight:800; margin-bottom:16px;">Is this the correct trash can?</div>
      <div class="product-modal-img-wrap">
        <img class="product-modal-img" id="trashCanModalImg" src="" alt="" style="display:none; max-width:200px; max-height:200px; border-radius:12px;" />
      </div>
      <div class="product-modal-brand" id="trashCanModalId" style="font-size:18px; font-weight:700; color:#041E42; margin-bottom:12px;"></div>
      <div class="product-modal-desc" id="trashCanModalDesc" style="background:#f5f5f5; padding:12px 16px; border-radius:10px; margin-bottom:20px; text-align:left;">
        <div style="font-size:14px; color:#0B2A5B; margin-bottom:4px; font-weight:600;">Location:</div>
        <div id="trashCanModalLocation" style="font-size:14px; color:#041E42; font-weight:600;"></div>
      </div>
      <div class="product-modal-btns">
        <button type="button" class="product-modal-btn-yes" onclick="confirmTrashCanYes()" style="background:#3AAFA9; color:white;">Yes</button>
        <button type="button" class="product-modal-btn-no" onclick="confirmTrashCanNo()" style="background:#E0E0E5; color:#041E42;">No</button>
      </div>
    </div>
  </div>

  <div class="modal" id="videoRecordModal">
    <div class="product-modal-box" style="max-width:500px;">
      <div class="product-modal-title">Record Video</div>
      <div style="margin-bottom:16px;">
        <video id="recordVideo" playsinline autoplay muted style="width:100%; max-width:400px; border-radius:12px; background:#000;"></video>
      </div>
      <div style="margin-bottom:16px; font-size:14px; color:#041E42;">
        <div id="videoTimer" style="font-size:18px; font-weight:700; color:#3AAFA9; text-align:center;">0s</div>
        <div style="text-align:center; margin-top:8px;">Record yourself throwing the item into the bin (5 seconds)</div>
      </div>
      <div class="product-modal-btns">
        <button type="button" class="product-modal-btn-yes" id="startRecordBtn" onclick="startVideoRecording()">Start Recording</button>
        <button type="button" class="product-modal-btn-no" id="stopRecordBtn" onclick="stopVideoRecording()" style="display:none;">Stop & Submit</button>
        <button type="button" class="product-modal-btn-no" onclick="cancelVideoRecording()">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal" id="verificationResultModal">
    <div class="product-modal-box">
      <div class="product-modal-title" id="verificationResultTitle" style="color:#041E42;">Verification Result</div>
      <div id="verificationResultMessage" style="margin-bottom:20px; font-size:15px; color:#041E42; text-align:center; line-height:1.6;"></div>
      <div id="verificationResultDetails" style="background:#f5f5f5; padding:14px 16px; border-radius:10px; margin-bottom:20px; font-size:13px; color:#041E42; text-align:left;"></div>
      <div class="product-modal-btns">
        <button type="button" class="product-modal-btn-yes" onclick="closeVerificationModal()" style="background:#3AAFA9;">OK</button>
      </div>
    </div>
  </div>

  <div class="modal" id="loginModal">
    <div class="modal-box">
      <div class="modal-title" id="loginModalTitle">Log into ClearCycle</div>
      
      <!-- Login/Register Top-Level Tabs -->
      <div style="display:flex; gap:10px; margin-bottom:24px;">
        <button type="button" class="modal-btn modal-confirm" id="loginTabBtn" onclick="switchLoginTab('login')" style="flex:1;">Login</button>
        <button type="button" class="modal-btn modal-cancel" id="registerTabBtn" onclick="switchLoginTab('register')" style="flex:1;">Register</button>
      </div>
      
      <!-- Login Section -->
      <div id="loginForm" style="display:block;">
        <!-- User/Admin Tab Selector for Login -->
        <div id="loginUserAdminTabs" style="border-radius: 16px; background: rgba(255,255,255,0.15); padding: 4px; border: 2px solid rgba(255,255,255,0.2); max-width: 28rem; margin: 0 auto 20px; display: flex; gap: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <button type="button" id="loginUserTabBtn" onclick="switchLoginUserAdminTab('user')" style="flex: 1; padding: 12px 16px; border: 2px solid #3AAFA9; border-radius: 12px; background: white; color: #041E42; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(58,175,169,0.25);">User</button>
          <button type="button" id="loginAdminTabBtn" onclick="switchLoginUserAdminTab('admin')" style="flex: 1; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.5); border-radius: 12px; background: rgba(255,255,255,0.4); color: #041E42; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease;">Admin</button>
        </div>
        
        <!-- User Login Form -->
        <div id="userLoginForm" style="display:block;">
          <input type="email" class="modal-input" id="loginEmail" placeholder="Email" />
          <input type="password" class="modal-input" id="loginPassword" placeholder="Password" />
          <div id="loginError" style="color:#dc2626; font-size:12px; margin-bottom:10px; display:none;"></div>
          <div class="modal-buttons">
            <button type="button" class="modal-btn modal-confirm" onclick="handleLogin()">Sign In</button>
            <button type="button" class="modal-btn modal-cancel" onclick="closeLoginModal()">Cancel</button>
          </div>
        </div>
        
        <!-- Admin Login Form -->
        <div id="adminLoginForm" style="display:none;">
          <input type="email" class="modal-input" id="adminLoginEmail" placeholder="Admin Email" />
          <input type="password" class="modal-input" id="adminLoginPassword" placeholder="Password" />
          <div id="adminLoginError" style="color:#dc2626; font-size:12px; margin-bottom:10px; display:none;"></div>
          <div class="modal-buttons">
            <button type="button" class="modal-btn modal-confirm" onclick="handleAdminLogin()">Sign In as Admin</button>
            <button type="button" class="modal-btn modal-cancel" onclick="closeLoginModal()">Cancel</button>
          </div>
        </div>
      </div>
      
      <!-- Register Section -->
      <div id="registerForm" style="display:none;">
        <!-- User/Admin Tab Selector for Register -->
        <div id="registerUserAdminTabs" style="border-radius: 16px; background: rgba(255,255,255,0.15); padding: 4px; border: 2px solid rgba(255,255,255,0.2); max-width: 28rem; margin: 0 auto 20px; display: flex; gap: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <button type="button" id="registerUserTabBtn" onclick="switchRegisterUserAdminTab('user')" style="flex: 1; padding: 12px 16px; border: 2px solid #3AAFA9; border-radius: 12px; background: white; color: #041E42; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 8px rgba(58,175,169,0.25);">User</button>
          <button type="button" id="registerAdminTabBtn" onclick="switchRegisterUserAdminTab('admin')" style="flex: 1; padding: 12px 16px; border: 2px solid rgba(255,255,255,0.5); border-radius: 12px; background: rgba(255,255,255,0.4); color: #041E42; font-weight: 700; font-size: 15px; cursor: pointer; transition: all 0.2s ease;">Admin</button>
        </div>
        
        <!-- User Register Form -->
        <div id="userRegisterSection" style="display:block;">
          <input type="text" class="modal-input" id="registerName" placeholder="Full name" />
          <input type="email" class="modal-input" id="registerEmail" placeholder="Email" />
          <input type="password" class="modal-input" id="registerPassword" placeholder="Password" />
          <select class="modal-input" id="registerRole" style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 10px; font-size: 14px; color: #041E42; background: white; cursor: pointer; margin-bottom: 16px;">
            <option value="" selected disabled>Please select</option>
            <option value="student">Student</option>
            <option value="teacher">Teacher</option>
            <option value="faculty">Faculty</option>
          </select>
          <div id="registerError" style="color:#dc2626; font-size:12px; margin-bottom:10px; display:none;"></div>
          <div class="modal-buttons">
            <button type="button" class="modal-btn modal-confirm" onclick="handleRegister()">Create Account</button>
            <button type="button" class="modal-btn modal-cancel" onclick="closeLoginModal()">Cancel</button>
          </div>
        </div>
        
        <!-- Admin Register Form -->
        <div id="adminRegisterSection" style="display:none;">
          <input type="text" class="modal-input" id="adminRegisterName" placeholder="Full name" />
          <input type="email" class="modal-input" id="adminRegisterEmail" placeholder="Admin Email" />
          <input type="password" class="modal-input" id="adminRegisterPassword" placeholder="Password" />
          <div id="adminRegisterError" style="color:#dc2626; font-size:12px; margin-bottom:10px; display:none;"></div>
          <div class="modal-buttons">
            <button type="button" class="modal-btn modal-confirm" onclick="handleAdminRegister()">Create Admin Account</button>
            <button type="button" class="modal-btn modal-cancel" onclick="closeLoginModal()">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API = (/^(http:\/\/localhost|http:\/\/127\.0\.0\.1):3000$/.test(window.location.origin)) ? 'http://localhost:4000' : '';
    const authState = { user: null, token: null };
    const state = { 
      points: 0, 
      streak: 0, 
      isScanning: false, 
      pendingBarcode: null,
      recycleSession: null,
      recycleStep: null, // 'product', 'bin', 'video'
      isRecording: false,
      mediaRecorder: null,
      recordedChunks: []
    };

    function switchTab(page) {
      // Guard: Prevent non-admin users from accessing admin page
      if (page === 'admin') {
        if (!authState.user || authState.user.role !== 'admin') {
          // Redirect non-admin users to home
          page = 'home';
        }
      }
      
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const el = document.getElementById('page-' + page);
      if (el) el.classList.add('active');
      document.querySelectorAll('.simple-nav-link').forEach(n => n.classList.remove('active'));
      document.querySelectorAll('.nav-item, .nav-dropdown').forEach(n => n.classList.remove('active'));
      if (page === 'admin') {
        updateAdminUI();
      } else if (page === 'scan') {
        // Reset scan state when entering scan page
        state.recycleSession = null;
        state.recycleStep = null;
        state.pendingBarcode = null;
        state.isScanning = false;
        const status = document.getElementById('status');
        if (status) status.textContent = 'Ready to scan';
        updateScanSteps();
      } else if (page === 'redeem') {
        // Update rewards page visibility when switching to it
        updateAuthUI();
        // Update rewards dashboard if logged in
        if (authState.user) {
          updateRewardsDashboard();
        }
      }
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.nav-dropdown.open').forEach(d => d.classList.remove('open'));
      document.getElementById('profileDropdown')?.classList.remove('open');
    }
    function closeLoginDropdown() {
      document.getElementById('loginDropdown')?.classList.remove('open');
    }
    function toggleProfileDropdown(event) {
      if (event) event.stopPropagation();
      const dropdown = document.getElementById('profileDropdown');
      if (dropdown) {
        dropdown.classList.toggle('open');
      }
    }
    function handleProfileMenuClick(action) {
      closeAllDropdowns();
      if (action === 'login') {
        toggleProfileOrLogin();
      } else if (action === 'logout') {
        const logoutBtn = document.getElementById('profileDropdownLogout');
        if (logoutBtn) {
          logoutBtn.classList.add('loading');
          logoutBtn.disabled = true;
        }
        // Small delay for visual feedback, then logout
        setTimeout(() => {
          logout();
          switchTab('home');
          if (logoutBtn) {
            logoutBtn.classList.remove('loading');
            logoutBtn.disabled = false;
          }
        }, 300);
      } else if (action === 'scan') {
        handleScanClick();
      } else if (action === 'rewards') {
        switchTab('redeem');
      }
    }
    function handleScanClick() {
      if (!authState.user) {
        // User not logged in - route to login
        toggleProfileOrLogin();
        return;
      }
      // User is logged in - route to scan
      switchTab('scan');
    }
    // Close dropdown on click outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('profileDropdown');
      if (dropdown && !dropdown.contains(event.target)) {
        dropdown.classList.remove('open');
      }
    });
    // Close dropdown on Escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllDropdowns();
      }
    });
    function toggleLoginDropdown() {
      closeAllDropdowns();
      const d = document.getElementById('loginDropdown');
      d.classList.toggle('open');
    }
    document.querySelectorAll('.nav-trigger').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.stopPropagation();
        closeLoginDropdown();
        const dd = this.closest('.nav-dropdown');
        const open = dd.classList.contains('open');
        closeAllDropdowns();
        if (!open) dd.classList.add('open');
      });
    });
    document.addEventListener('click', function(e) {
      if (e.target.closest('.nav-dropdown') || e.target.closest('.login-wrap')) return;
      closeAllDropdowns();
      closeLoginDropdown();
    });

    function toggleProfileOrLogin() {
      closeLoginDropdown();
      const modal = document.getElementById('loginModal');
      if (modal.classList.contains('show')) { modal.classList.remove('show'); return; }
      
      // Check URL query parameter for mode
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      
      // Set active tab based on query parameter, default to 'user'
      switchLoginTab('login');
      if (mode === 'admin') {
        switchLoginUserAdminTab('admin');
      } else {
        switchLoginUserAdminTab('user');
      }
      modal.classList.add('show');
    }
    // State for Login User/Admin tab
    let activeLoginUserAdminTab = 'user';
    
    function switchLoginUserAdminTab(tab) {
      activeLoginUserAdminTab = tab;
      const userLoginForm = document.getElementById('userLoginForm');
      const adminLoginForm = document.getElementById('adminLoginForm');
      const loginUserTabBtn = document.getElementById('loginUserTabBtn');
      const loginAdminTabBtn = document.getElementById('loginAdminTabBtn');
      
      if (tab === 'user') {
        userLoginForm.style.display = 'block';
        adminLoginForm.style.display = 'none';
        // Active User button
        loginUserTabBtn.style.background = 'white';
        loginUserTabBtn.style.color = '#041E42';
        loginUserTabBtn.style.boxShadow = '0 2px 8px rgba(58,175,169,0.25)';
        loginUserTabBtn.style.border = '2px solid #3AAFA9';
        // Inactive Admin button
        loginAdminTabBtn.style.background = 'rgba(255,255,255,0.4)';
        loginAdminTabBtn.style.color = '#041E42';
        loginAdminTabBtn.style.boxShadow = 'none';
        loginAdminTabBtn.style.border = '2px solid rgba(255,255,255,0.5)';
      } else {
        userLoginForm.style.display = 'none';
        adminLoginForm.style.display = 'block';
        // Active Admin button
        loginAdminTabBtn.style.background = 'white';
        loginAdminTabBtn.style.color = '#041E42';
        loginAdminTabBtn.style.boxShadow = '0 2px 8px rgba(58,175,169,0.25)';
        loginAdminTabBtn.style.border = '2px solid #3AAFA9';
        // Inactive User button
        loginUserTabBtn.style.background = 'rgba(255,255,255,0.4)';
        loginUserTabBtn.style.color = '#041E42';
        loginUserTabBtn.style.boxShadow = 'none';
        loginUserTabBtn.style.border = '2px solid rgba(255,255,255,0.5)';
      }
    }
    
    // State for Register User/Admin tab
    let activeRegisterUserAdminTab = 'user';
    
    function switchRegisterUserAdminTab(tab) {
      activeRegisterUserAdminTab = tab;
      const userRegisterSection = document.getElementById('userRegisterSection');
      const adminRegisterSection = document.getElementById('adminRegisterSection');
      const registerUserTabBtn = document.getElementById('registerUserTabBtn');
      const registerAdminTabBtn = document.getElementById('registerAdminTabBtn');
      
      if (tab === 'user') {
        userRegisterSection.style.display = 'block';
        adminRegisterSection.style.display = 'none';
        // Active User button
        registerUserTabBtn.style.background = 'white';
        registerUserTabBtn.style.color = '#041E42';
        registerUserTabBtn.style.boxShadow = '0 2px 8px rgba(58,175,169,0.25)';
        registerUserTabBtn.style.border = '2px solid #3AAFA9';
        // Inactive Admin button
        registerAdminTabBtn.style.background = 'rgba(255,255,255,0.4)';
        registerAdminTabBtn.style.color = '#041E42';
        registerAdminTabBtn.style.boxShadow = 'none';
        registerAdminTabBtn.style.border = '2px solid rgba(255,255,255,0.5)';
      } else {
        userRegisterSection.style.display = 'none';
        adminRegisterSection.style.display = 'block';
        // Active Admin button
        registerAdminTabBtn.style.background = 'white';
        registerAdminTabBtn.style.color = '#041E42';
        registerAdminTabBtn.style.boxShadow = '0 2px 8px rgba(58,175,169,0.25)';
        registerAdminTabBtn.style.border = '2px solid #3AAFA9';
        // Inactive User button
        registerUserTabBtn.style.background = 'rgba(255,255,255,0.4)';
        registerUserTabBtn.style.color = '#041E42';
        registerUserTabBtn.style.boxShadow = 'none';
        registerUserTabBtn.style.border = '2px solid rgba(255,255,255,0.5)';
      }
    }
    
    function showLoginModal() {
      // Check URL query parameter for mode
      const urlParams = new URLSearchParams(window.location.search);
      const mode = urlParams.get('mode');
      
      // Set active tab based on query parameter, default to 'user'
      switchLoginTab('login');
      if (mode === 'admin') {
        switchLoginUserAdminTab('admin');
      } else {
        switchLoginUserAdminTab('user');
      }
      document.getElementById('loginModal').classList.add('show'); 
    }
    function closeLoginModal() {
      document.getElementById('loginModal').classList.remove('show');
      document.getElementById('loginEmail').value = '';
      document.getElementById('loginPassword').value = '';
      document.getElementById('registerName').value = '';
      document.getElementById('registerEmail').value = '';
      document.getElementById('registerPassword').value = '';
      const registerRole = document.getElementById('registerRole');
      if (registerRole) registerRole.value = '';
      document.getElementById('adminLoginEmail').value = '';
      document.getElementById('adminLoginPassword').value = '';
      document.getElementById('adminRegisterName').value = '';
      document.getElementById('adminRegisterEmail').value = '';
      document.getElementById('adminRegisterPassword').value = '';
      document.getElementById('loginError').style.display = 'none';
      document.getElementById('registerError').style.display = 'none';
      document.getElementById('adminLoginError').style.display = 'none';
      document.getElementById('adminRegisterError').style.display = 'none';
      // Reset to user tab
      switchLoginUserAdminTab('user');
      switchRegisterUserAdminTab('user');
    }
    function switchLoginTab(tab) {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const loginBtn = document.getElementById('loginTabBtn');
      const regBtn = document.getElementById('registerTabBtn');
      const modalTitle = document.getElementById('loginModalTitle');
      if (tab === 'login') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        loginBtn.style.background = '#3AAFA9';
        loginBtn.style.color = 'white';
        loginBtn.style.border = 'none';
        loginBtn.style.boxShadow = '0 4px 12px rgba(58,175,169,0.3)';
        regBtn.style.background = '#f3f4f6';
        regBtn.style.color = '#041E42';
        regBtn.style.border = '2px solid #d1d5db';
        regBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
        // Update title
        if (modalTitle) modalTitle.textContent = 'Log in to ClearCycle';
        // Reset login tabs to user when showing login form
        switchLoginUserAdminTab('user');
      } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        regBtn.style.background = '#3AAFA9';
        regBtn.style.color = 'white';
        regBtn.style.border = 'none';
        regBtn.style.boxShadow = '0 4px 12px rgba(58,175,169,0.3)';
        loginBtn.style.background = '#f3f4f6';
        loginBtn.style.color = '#041E42';
        loginBtn.style.border = '2px solid #d1d5db';
        loginBtn.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
        // Update title
        if (modalTitle) modalTitle.textContent = 'Register into ClearCycle';
        // Reset register tabs to user when showing register form
        switchRegisterUserAdminTab('user');
      }
    }
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const err = document.getElementById('loginError');
      if (!email || !password) { err.textContent = 'Email and password required'; err.style.display = 'block'; return; }
      try {
        const res = await fetch(API + '/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (data.token) {
          authState.token = data.token;
          authState.user = data.user || { email, name: 'User', role: 'student' };
          localStorage.setItem('cc_token', data.token);
          localStorage.setItem('cc_user', JSON.stringify(authState.user));
          closeLoginModal();
          updateAuthUI();
          // Redirect admin users to admin dashboard, regular users to home
          if (authState.user && authState.user.role === 'admin') {
            switchTab('admin');
          } else {
            switchTab('home');
          }
          if (document.getElementById('page-admin').classList.contains('active')) updateAdminUI();
          return;
        }
        err.textContent = data.error || 'Login failed';
        err.style.display = 'block';
      } catch (e) {
        err.textContent = 'Network error. Is the backend running?';
        err.style.display = 'block';
      }
    }
    async function handleAdminLogin() {
      const email = document.getElementById('adminLoginEmail').value.trim();
      const password = document.getElementById('adminLoginPassword').value.trim();
      const err = document.getElementById('adminLoginError');
      if (!email || !password) { err.textContent = 'Email and password required'; err.style.display = 'block'; return; }
      try {
        const res = await fetch(API + '/api/auth/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ email, password }) });
        const data = await res.json();
        if (data.token) {
          // Check if user is actually an admin
          const user = data.user || { email, name: 'User', role: 'student' };
          if (user.role !== 'admin') {
            err.textContent = 'Access denied. Admin account required.';
            err.style.display = 'block';
            return;
          }
          authState.token = data.token;
          authState.user = user;
          localStorage.setItem('cc_token', data.token);
          localStorage.setItem('cc_user', JSON.stringify(authState.user));
          closeLoginModal();
          updateAuthUI();
          // Redirect admin users to admin dashboard
          switchTab('admin');
          if (document.getElementById('page-admin').classList.contains('active')) updateAdminUI();
          return;
        }
        err.textContent = data.error || 'Login failed';
        err.style.display = 'block';
      } catch (e) {
        err.textContent = 'Network error. Is the backend running?';
        err.style.display = 'block';
      }
    }
    async function handleRegister() {
      const name = document.getElementById('registerName').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value.trim();
      const role = document.getElementById('registerRole').value;
      const err = document.getElementById('registerError');
      if (!name || !email || !password || !role) { err.textContent = 'Name, email, password, and role are required'; err.style.display = 'block'; return; }
      try {
        const res = await fetch(API + '/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, password, role: role }) });
        const data = await res.json();
        if (data.token) {
          authState.token = data.token;
          authState.user = data.user || { email, name, role: role };
          localStorage.setItem('cc_token', data.token);
          localStorage.setItem('cc_user', JSON.stringify(authState.user));
          closeLoginModal();
          updateAuthUI();
          switchTab('home');
          return;
        }
        err.textContent = data.error || 'Registration failed';
        err.style.display = 'block';
      } catch (e) {
        err.textContent = 'Network error. Is the backend running?';
        err.style.display = 'block';
      }
    }
    async function handleAdminRegister() {
      const name = document.getElementById('adminRegisterName').value.trim();
      const email = document.getElementById('adminRegisterEmail').value.trim();
      const password = document.getElementById('adminRegisterPassword').value.trim();
      const err = document.getElementById('adminRegisterError');
      if (!name || !email || !password) { err.textContent = 'Name, email, and password required'; err.style.display = 'block'; return; }
      try {
        const res = await fetch(API + '/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, email, password, role: 'admin' }) });
        const data = await res.json();
        if (data.token) {
          authState.token = data.token;
          authState.user = data.user || { email, name, role: 'admin' };
          localStorage.setItem('cc_token', data.token);
          localStorage.setItem('cc_user', JSON.stringify(authState.user));
          closeLoginModal();
          updateAuthUI();
          // Redirect admin users to admin dashboard
          switchTab('admin');
          if (document.getElementById('page-admin').classList.contains('active')) updateAdminUI();
          return;
        }
        err.textContent = data.error || 'Registration failed';
        err.style.display = 'block';
      } catch (e) {
        err.textContent = 'Network error. Is the backend running?';
        err.style.display = 'block';
      }
    }
    function logout() {
      authState.token = null;
      authState.user = null;
      localStorage.removeItem('cc_token');
      localStorage.removeItem('cc_user');
      updateAuthUI();
      closeLoginDropdown();
      closeAllDropdowns();
    }
    function updateAuthUI() {
      const token = localStorage.getItem('cc_token');
      const userJson = localStorage.getItem('cc_user');
      if (token && userJson) {
        try {
          authState.token = token;
          authState.user = JSON.parse(userJson);
        } catch (_) {}
      }
      const btnLogin = document.getElementById('btnLogin');
      const btnSignOut = document.getElementById('btnSignOut');
      const loginOpt = document.getElementById('loginDropdownLogin');
      if (authState.user) {
        if (btnLogin) { btnLogin.title = authState.user.email || 'Account'; btnLogin.textContent = 'üë§ Account'; }
        if (btnSignOut) { btnSignOut.style.display = 'block'; btnSignOut.textContent = 'Sign Out'; }
        if (loginOpt) loginOpt.style.display = 'none';
      } else {
        if (btnLogin) { btnLogin.title = 'Log in'; btnLogin.textContent = 'üë§ Log in'; }
        if (btnSignOut) btnSignOut.style.display = 'none';
        if (loginOpt) loginOpt.style.display = 'block';
      }
      const adminNav = document.getElementById('navAdmin');
      if (adminNav) adminNav.style.display = (authState.user && authState.user.role === 'admin') ? 'block' : 'none';
      // Update active nav on page load
      const currentPage = document.querySelector('.page.active');
      if (currentPage) {
        const pageId = currentPage.id.replace('page-', '');
        switchTab(pageId);
      }
      const headerPts = document.getElementById('headerPts');
      if (headerPts) headerPts.style.display = authState.user ? 'inline-block' : 'none';
      const profileLoginBtn = document.getElementById('profileLoginBtn');
      if (profileLoginBtn) {
        if (authState.user) {
          profileLoginBtn.textContent = 'Account';
          profileLoginBtn.style.display = 'none';
        } else {
          profileLoginBtn.textContent = 'Log in';
          profileLoginBtn.style.display = 'block';
        }
      }
      
      // Update home page visibility based on auth state
      const landingPage = document.getElementById('landing-page');
      const loggedInHome = document.getElementById('logged-in-home');
      if (landingPage && loggedInHome) {
        if (authState.user) {
          landingPage.style.display = 'none';
          loggedInHome.style.display = 'block';
        } else {
          landingPage.style.display = 'block';
          loggedInHome.style.display = 'none';
        }
      }
      
      // Update rewards page visibility based on auth state
      const rewardsLoggedIn = document.getElementById('rewards-logged-in');
      const rewardsLoggedOut = document.getElementById('rewards-logged-out');
      if (rewardsLoggedIn && rewardsLoggedOut) {
        if (authState.user) {
          rewardsLoggedIn.style.display = 'block';
          rewardsLoggedOut.style.display = 'none';
        } else {
          rewardsLoggedIn.style.display = 'none';
          rewardsLoggedOut.style.display = 'block';
        }
      }
      
      // Update Profile dropdown menu items based on auth state
      const profileDropdownLogin = document.getElementById('profileDropdownLogin');
      const profileDropdownLogout = document.getElementById('profileDropdownLogout');
      const profileDropdownRewards = document.getElementById('profileDropdownRewards');
      const profileDropdownText = document.getElementById('profileDropdownText');
      if (profileDropdownLogin && profileDropdownLogout) {
        if (authState.user) {
          // User is logged in (regular or admin)
          profileDropdownLogin.style.display = 'none';
          profileDropdownLogout.style.display = 'block';
          // Hide Rewards for admin users, show for regular users
          if (profileDropdownRewards) {
            if (authState.user.role === 'admin') {
              profileDropdownRewards.style.display = 'none';
            } else {
              profileDropdownRewards.style.display = 'block';
            }
          }
          // Update Profile text to show user's name
          if (profileDropdownText) {
            profileDropdownText.textContent = authState.user.name || authState.user.email || 'Profile';
          }
        } else {
          // User is logged out
          profileDropdownLogin.style.display = 'block';
          profileDropdownLogout.style.display = 'none';
          // Show Rewards when logged out
          if (profileDropdownRewards) {
            profileDropdownRewards.style.display = 'block';
          }
          // Reset to "Profile" when logged out
          if (profileDropdownText) {
            profileDropdownText.textContent = 'Profile';
          }
        }
      }
      
      if (authState.user) {
        if (typeof loadUserData === 'function') loadUserData();
      }
      if (authState.user && authState.user.role === 'admin') {
        if (document.getElementById('page-admin')?.classList.contains('active')) updateAdminUI();
      }
    }
    function updateAdminUI() {
      const panel = document.getElementById('adminPanel');
      const req = document.getElementById('adminAuthRequired');
      if (authState.user && authState.user.role === 'admin') {
        if (panel) panel.style.display = 'block';
        if (req) req.style.display = 'none';
        loadTrashCans();
      } else {
        if (panel) panel.style.display = 'none';
        if (req) req.style.display = 'block';
      }
    }
    async function loadTrashCans() {
      const listEl = document.getElementById('adminTrashCansList');
      if (!listEl) return;
      try {
        const res = await fetch(API + '/api/trash-cans');
        const data = await res.json();
        const cans = data.cans || data || [];
        if (cans.length === 0) {
          listEl.innerHTML = '<p style="color:#64748b; font-size:14px;">No trash cans yet. Create one above!</p>';
          return;
        }
        listEl.innerHTML = cans.map(can => `
          <div style="background:white; padding:20px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; align-items:center; justify-content:space-between; gap:16px;">
            <div style="flex:1;">
              <div style="font-size:18px; font-weight:700; color:#041E42; margin-bottom:6px;">${can.id || 'Unknown'}</div>
              <div style="font-size:14px; color:#64748b; line-height:1.4;">
                ${can.label || ''}${can.location ? ' - ' + can.location : ''}
              </div>
            </div>
            <button type="button" onclick="downloadQR('${can.id}')" style="padding:10px 20px; background:#3AAFA9; color:white; border:none; border-radius:10px; font-weight:700; font-size:14px; cursor:pointer; transition:all 0.2s ease; white-space:nowrap;">Download QR</button>
          </div>
        `).join('');
      } catch (err) {
        listEl.innerHTML = '<p style="color:#dc2626; font-size:14px;">Error loading trash cans: ' + (err.message || 'Network error') + '</p>';
      }
    }
    async function createTrashCan() {
      const id = document.getElementById('adminCanId').value.trim();
      const label = document.getElementById('adminCanLabel').value.trim();
      const location = document.getElementById('adminCanLocation').value.trim();
      if (!id) {
        alert('Can ID is required');
        return;
      }
      if (!authState.token) {
        alert('Please log in as admin');
        showLoginModal();
        return;
      }
      try {
        const res = await fetch(API + '/api/trash-cans', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + authState.token
          },
          body: JSON.stringify({ id, label, location })
        });
        const data = await res.json();
        if (res.ok && data.saved) {
          document.getElementById('adminCanId').value = '';
          document.getElementById('adminCanLabel').value = '';
          document.getElementById('adminCanLocation').value = '';
          loadTrashCans();
          alert('Trash can created successfully!');
        } else {
          alert(data.error || 'Failed to create trash can');
        }
      } catch (err) {
        alert('Error creating trash can: ' + (err.message || 'Network error'));
      }
    }
    async function downloadQR(canId) {
      try {
        const qrUrl = API + '/api/qr?canId=' + encodeURIComponent(canId);
        const response = await fetch(qrUrl);
        if (!response.ok) {
          throw new Error('Failed to generate QR code');
        }
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `qr-${canId}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert('Error downloading QR code: ' + (err.message || 'Network error'));
      }
    }

    function updatePointsTracker() {
      const pts = state.points || 0;
      const pct = Math.min(100, (pts / 1000) * 100);
      const numEl = document.getElementById('trackerPointsNumber');
      const fillEl = document.getElementById('pointsTrackerFill');
      const capEl = document.getElementById('pointsTrackerCap');
      const homeNumEl = document.getElementById('homeTrackerPointsNumber');
      const homeFillEl = document.getElementById('homePointsTrackerFill');
      const homeCapEl = document.getElementById('homePointsTrackerCap');
      if (numEl) numEl.textContent = pts;
      if (homeNumEl) homeNumEl.textContent = pts;
      if (fillEl) {
        fillEl.style.width = pct + '%';
        fillEl.style.borderRadius = pct >= 100 ? '12px' : '12px 0 0 12px';
      }
      if (homeFillEl) {
        homeFillEl.style.width = pct + '%';
        homeFillEl.style.borderRadius = pct >= 100 ? '12px' : '12px 0 0 12px';
      }
      if (capEl) {
        capEl.style.left = pct + '%';
        capEl.style.display = pts > 0 ? 'block' : 'none';
      }
      if (homeCapEl) {
        homeCapEl.style.left = pct + '%';
        homeCapEl.style.display = pts > 0 ? 'block' : 'none';
      }
    }

    function loadPoints() {
      try {
        const p = parseInt(localStorage.getItem('cc_points'), 10);
        const s = parseInt(localStorage.getItem('cc_streak'), 10);
        state.points = isNaN(p) ? 0 : p;
        state.streak = isNaN(s) ? 0 : s;
      } catch (_) {}
      const pd = document.getElementById('pointsDisplay');
      const pp = document.getElementById('profilePointsDisplay');
      const sd = document.getElementById('streakDays');
      const ps = document.getElementById('profileStreakDays');
      const hp = document.getElementById('headerPts');
      const homePts = document.getElementById('homePointsDisplay');
      const homeStreak = document.getElementById('homeStreakDays');
      const rewardsBadge = document.getElementById('rewardsPointsBadge');
      if (pd) pd.textContent = state.points;
      if (pp) pp.textContent = state.points;
      if (sd) sd.textContent = state.streak;
      if (ps) ps.textContent = state.streak;
      if (hp) hp.textContent = state.points + ' pts';
      if (homePts) homePts.textContent = state.points;
      if (homeStreak) homeStreak.textContent = state.streak;
      if (rewardsBadge) rewardsBadge.textContent = state.points + ' pts';
      updatePointsTracker();
      updateRewardsDashboard();
    }

    // Function to toggle category expansion
    function toggleCategories(btn) {
      const categoryValue = document.getElementById('productModalCategoryValue');
      if (!categoryValue) return;
      
      const allCategories = JSON.parse(categoryValue.dataset.allCategories || '[]');
      const isExpanded = categoryValue.dataset.expanded === 'true';
      
      let html = '';
      if (isExpanded) {
        // Collapse: show only first 3
        const displayCategories = allCategories.slice(0, 3);
        const remainingCount = allCategories.length - 3;
        
        displayCategories.forEach(cat => {
          html += `<span style="display: inline-block; background: #f3f4f6; color: #041E42; padding: 4px 12px; border-radius: 9999px; font-size: 13px; margin: 4px 4px 4px 0; font-weight: 500;">${cat}</span>`;
        });
        
        if (remainingCount > 0) {
          html += `<span id="categoryExpandBtn" style="display: inline-block; color: #3AAFA9; font-size: 13px; margin-left: 8px; font-weight: 600; cursor: pointer; text-decoration: underline; transition: opacity 0.2s ease;" onclick="toggleCategories(this)" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">+ ${remainingCount} more</span>`;
        }
        
        categoryValue.dataset.expanded = 'false';
      } else {
        // Expand: show all categories
        allCategories.forEach(cat => {
          html += `<span style="display: inline-block; background: #f3f4f6; color: #041E42; padding: 4px 12px; border-radius: 9999px; font-size: 13px; margin: 4px 4px 4px 0; font-weight: 500;">${cat}</span>`;
        });
        
        html += `<span id="categoryExpandBtn" style="display: inline-block; color: #3AAFA9; font-size: 13px; margin-left: 8px; font-weight: 600; cursor: pointer; text-decoration: underline; transition: opacity 0.2s ease;" onclick="toggleCategories(this)" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">Show less</span>`;
        
        categoryValue.dataset.expanded = 'true';
      }
      
      categoryValue.innerHTML = html;
    }
    
    // Helper function to clean and format category strings
    function cleanCategoryString(catStr) {
      if (!catStr || catStr === 'Unknown' || typeof catStr !== 'string') {
        return [];
      }
      
      // Split by comma and clean each item
      const categories = catStr.split(',')
        .map(cat => cat.trim())
        .filter(cat => cat.length > 0)
        .map(cat => {
          // Remove "en:" prefix
          if (cat.startsWith('en:')) {
            cat = cat.substring(3).trim();
          }
          // Remove redundant prefixes like "en:Products for specific diets" -> "Products for specific diets"
          // Capitalize first letter
          if (cat.length > 0) {
            cat = cat.charAt(0).toUpperCase() + cat.slice(1).toLowerCase();
          }
          return cat;
        })
        .filter(cat => {
          // Remove duplicates and very generic/redundant categories
          const lower = cat.toLowerCase();
          return !lower.includes('specific products') && 
                 !lower.includes('products for') &&
                 cat.length > 2;
        });
      
      // Remove duplicates
      return [...new Set(categories)];
    }
    
    function showProductModal(data, barcode) {
      state.pendingBarcode = barcode;
      // Store product data for recyclability check
      state.lastProductData = data || {};
      const title = document.getElementById('productModalTitle');
      const img = document.getElementById('productModalImg');
      const brandSubtitle = document.getElementById('productModalBrand');
      const brandValue = document.getElementById('productModalBrandValue');
      const categoryValue = document.getElementById('productModalCategoryValue');
      
      // Handle product data - use provided data or defaults
      // Make sure we get the actual product name, not "Unknown" if data exists
      let name = 'Unknown';
      if (data && data.name) {
        name = data.name.trim();
        // If name is "Unknown" but we have brand, use brand as name
        if (name === 'Unknown' && data.brand && data.brand.trim()) {
          name = data.brand.trim();
        }
      }
      // If still unknown, show barcode
      if (!name || name === 'Unknown') {
        name = `Product (Barcode: ${barcode})`;
      }
      
      const brandStr = (data && data.brand) ? (data.brand.trim() || 'Unknown') : 'Unknown';
      let catStr = (data && data.category) ? data.category : 'Unknown';
      
      // Set title (product name)
      if (title) title.textContent = name;
      
      // Set brand subtitle
      if (brandSubtitle) {
        brandSubtitle.textContent = brandStr !== 'Unknown' ? brandStr : '';
      }
      
      // Set brand value in details card
      if (brandValue) {
        brandValue.textContent = brandStr !== 'Unknown' ? brandStr : '‚Äî';
      }
      
      // Format and display categories
      if (categoryValue) {
        const categories = cleanCategoryString(catStr);
        if (categories.length === 0) {
          categoryValue.textContent = '‚Äî';
        } else {
          // Store all categories for expand/collapse functionality
          categoryValue.dataset.allCategories = JSON.stringify(categories);
          categoryValue.dataset.expanded = 'false';
          
          // Show top 3 categories as pills, or all if 3 or fewer
          const displayCategories = categories.slice(0, 3);
          const remainingCount = categories.length - 3;
          
          let html = '';
          displayCategories.forEach(cat => {
            html += `<span style="display: inline-block; background: #f3f4f6; color: #041E42; padding: 4px 12px; border-radius: 9999px; font-size: 13px; margin: 4px 4px 4px 0; font-weight: 500;">${cat}</span>`;
          });
          
          if (remainingCount > 0) {
            html += `<span id="categoryExpandBtn" style="display: inline-block; color: #3AAFA9; font-size: 13px; margin-left: 8px; font-weight: 600; cursor: pointer; text-decoration: underline; transition: opacity 0.2s ease;" onclick="toggleCategories(this)" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">+ ${remainingCount} more</span>`;
          }
          
          categoryValue.innerHTML = html;
        }
      }
      
      // Set recyclability message
      const recyclabilityEl = document.getElementById('productModalRecyclability');
      console.log('Recyclability element found:', !!recyclabilityEl);
      console.log('Recyclability data:', {
        recyclable: data?.recyclable,
        message: data?.recyclabilityMessage,
        confidence: data?.recyclabilityConfidence
      });
      
      if (recyclabilityEl && data && data.recyclable !== undefined && data.recyclable !== null) {
        console.log('Displaying recyclability:', data.recyclable === true ? 'RECYCLABLE' : 'NOT RECYCLABLE');
        if (data.recyclable === true) {
          recyclabilityEl.style.display = 'block';
          recyclabilityEl.style.background = 'rgba(58,175,169,0.1)';
          recyclabilityEl.style.color = '#041E42';
          recyclabilityEl.style.border = '1px solid #3AAFA9';
          recyclabilityEl.innerHTML = '<strong style="font-size:14px;">‚úì Recyclable</strong><br>' + 
            (data.recyclabilityMessage || 'This item can be recycled.');
        } else if (data.recyclable === false) {
          recyclabilityEl.style.display = 'block';
          recyclabilityEl.style.background = '#FFEBEE';
          recyclabilityEl.style.color = '#C62828';
          recyclabilityEl.style.border = '1px solid #EF5350';
          recyclabilityEl.innerHTML = '<strong style="font-size:14px;">‚úó Not Recyclable</strong><br>' + 
            (data.recyclabilityMessage || 'This item cannot be recycled.') + 
            '<br><span style="font-size:12px; font-style:italic;">Clicking "Yes" will cancel and return to home.</span>';
          
          // Disable or hide the Yes button, or change its behavior
          const yesBtn = document.getElementById('productModalYes');
          if (yesBtn) {
            yesBtn.textContent = 'OK';
            yesBtn.onclick = function() {
              alert('This item is not recyclable. Please dispose of it in regular trash.');
              closeProductModal();
              state.pendingBarcode = null;
              state.recycleSession = null;
              state.recycleStep = null;
              state.lastProductData = null;
              switchTab('home');
              const status = document.getElementById('status');
              if (status) status.textContent = 'Ready to scan';
              updateScanSteps();
            };
          }
        } else {
          console.log('Recyclability is null/undefined, hiding element');
          recyclabilityEl.style.display = 'none';
        }
      } else {
        console.log('Recyclability not available, hiding element');
        if (recyclabilityEl) {
          recyclabilityEl.style.display = 'none';
        }
      }
      
      // Set image
      if (img) {
        if (data && data.image) {
          // Handle both relative and absolute URLs
          const imgSrc = data.image.startsWith('http') ? data.image : (data.image.startsWith('/') ? API + data.image : data.image);
          img.src = imgSrc;
          img.alt = name;
          img.style.display = 'block';
        } else {
          img.style.display = 'none';
          img.removeAttribute('src');
        }
      }
      
      const modal = document.getElementById('productConfirmModal');
      if (modal) {
        modal.classList.add('show');
      }
    }
    async function confirmProductYes() {
      if (!state.pendingBarcode) {
        closeProductModal();
        return;
      }
      
      // Check if product is recyclable - get the data from the modal
      const productData = state.lastProductData || {};
      if (productData.recyclable === false) {
        // Product is not recyclable - cancel and go back to home
        alert('This item is not recyclable. Please dispose of it in regular trash.');
        closeProductModal();
        state.pendingBarcode = null;
        state.recycleSession = null;
        state.recycleStep = null;
        state.lastProductData = null;
        
        // Go back to home page
        switchTab('home');
        const status = document.getElementById('status');
        if (status) status.textContent = 'Ready to scan';
        updateScanSteps();
        return;
      }
      
      // If recyclability is unknown (null), still allow them to proceed (might be checking)
      // Only block if explicitly false
      
      const email = authState.user?.email || 'demo@clear.cycle';
      try {
        // Start recycle session
        const startRes = await fetch(API + '/api/recycle/session/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });
        const startData = await startRes.json();
        if (!startRes.ok || !startData.sessionId) {
          throw new Error(startData.error || 'Failed to start session');
        }
        state.recycleSession = startData.sessionId;
        state.recycleStep = 'bin';
        // Submit product barcode
        const productRes = await fetch(API + '/api/recycle/session/' + startData.sessionId + '/product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode: state.pendingBarcode })
        });
        const productResData = await productRes.json();
        if (!productRes.ok) {
          throw new Error(productResData.error || 'Failed to submit product');
        }
        closeProductModal();
        const status = document.getElementById('status');
        if (status) status.textContent = 'Product confirmed! Now scan the trash can QR code';
        updateScanSteps();
      } catch (err) {
        alert('Error: ' + (err.message || 'Failed to confirm product'));
        closeProductModal();
      }
    }
    function confirmProductNo() {
      state.pendingBarcode = null;
      state.recycleSession = null;
      state.recycleStep = null;
      state.lastProductData = null;
      const status = document.getElementById('status');
      if (status) status.textContent = 'Ready to scan';
      closeProductModal();
    }
    
    function closeProductModal() {
      state.pendingBarcode = null;
      // Reset Yes button to default behavior
      const yesBtn = document.getElementById('productModalYes');
      if (yesBtn) {
        yesBtn.textContent = 'Yes';
        yesBtn.onclick = confirmProductYes;
      }
      document.getElementById('productConfirmModal').classList.remove('show');
    }
    function updateScanSteps() {
      const step1 = document.getElementById('step1');
      const step2 = document.getElementById('step2');
      const step3 = document.getElementById('step3');
      if (step1) step1.style.color = state.recycleStep === 'product' || !state.recycleStep ? '#041E42' : '#3AAFA9';
      if (step2) step2.style.color = state.recycleStep === 'bin' ? '#041E42' : (state.recycleStep === 'video' ? '#3AAFA9' : '#8A8D8F');
      if (step3) step3.style.color = state.recycleStep === 'video' ? '#041E42' : '#8A8D8F';
    }
    function showTrashCanModal(canId, label, location, imageUrl) {
      const title = document.getElementById('trashCanModalTitle');
      const id = document.getElementById('trashCanModalId');
      const locationEl = document.getElementById('trashCanModalLocation');
      const img = document.getElementById('trashCanModalImg');
      
      // Title should always be "Is this the correct trash can?"
      if (title) title.textContent = 'Is this the correct trash can?';
      
      // Display the can ID (e.g., TC001) - this is what the user wants to see
      if (id) id.textContent = canId || 'Unknown';
      
      // Display location (e.g., "Smayans house")
      if (locationEl) locationEl.textContent = location || label || 'Unknown location';
      
      // Display image if available
      if (img) {
        if (imageUrl) {
          // Handle both relative and absolute URLs
          const imgSrc = imageUrl.startsWith('http') ? imageUrl : (API + imageUrl);
          img.src = imgSrc;
          img.alt = label || canId;
          img.style.display = 'block';
        } else {
          img.style.display = 'none';
          img.removeAttribute('src');
        }
      }
      
      document.getElementById('trashCanConfirmModal').classList.add('show');
    }
    function closeTrashCanModal() {
      document.getElementById('trashCanConfirmModal').classList.remove('show');
    }
    async function confirmTrashCanYes() {
      if (!state.recycleSession || !state.pendingBarcode) {
        closeTrashCanModal();
        return;
      }
      try {
        const binRes = await fetch(API + '/api/recycle/session/' + state.recycleSession + '/bin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ barcode: state.pendingBarcode })
        });
        const binData = await binRes.json();
        if (!binRes.ok) {
          throw new Error(binData.error || 'Failed to submit trash can');
        }
        state.recycleStep = 'video';
        state.pendingBarcode = null;
        closeTrashCanModal();
        const status = document.getElementById('status');
        if (status) status.textContent = 'Trash can confirmed! Ready to record video';
        updateScanSteps();
        // Show video recording modal
        setTimeout(() => {
          document.getElementById('videoRecordModal').classList.add('show');
          setupVideoRecording();
        }, 500);
      } catch (err) {
        alert('Error: ' + (err.message || 'Failed to confirm trash can'));
        closeTrashCanModal();
      }
    }
    function confirmTrashCanNo() {
      state.pendingBarcode = null;
      const status = document.getElementById('status');
      if (status) status.textContent = 'Scan the correct trash can QR code';
      closeTrashCanModal();
    }

    const reader = new (typeof ZXing !== 'undefined' ? ZXing : window.ZXing).BrowserMultiFormatReader();
    function startScan() {
      if (state.isScanning) return;
      const video = document.getElementById('video');
      if (!video) return;
      state.isScanning = true;
      const status = document.getElementById('status');
      const btn = document.getElementById('scanBtn');
      
      // Determine what we're scanning based on current step
      const currentStep = state.recycleStep || 'product';
      if (status) {
        status.textContent = currentStep === 'product' ? 'Starting camera...' : 'Scanning QR code...';
      }
      if (btn) btn.disabled = true;
      
      reader.decodeFromVideoDevice(undefined, video, (result, err) => {
        if (result) {
          state.isScanning = false;
          if (btn) btn.disabled = false;
          const barcode = result.getText();
          try { reader.reset(); } catch (_) {}
          if (video.srcObject) {
            video.srcObject.getTracks().forEach(t => t.stop());
            video.srcObject = null;
          }
          
          if (currentStep === 'product') {
            // Step 1: Product scan
            if (status) status.textContent = 'Looking up product...';
            
            // Use a timeout to prevent hanging
            const fetchWithTimeout = (url, timeout = 10000) => {
              return Promise.race([
                fetch(url),
                new Promise((_, reject) => 
                  setTimeout(() => reject(new Error('Request timeout')), timeout)
                )
              ]);
            };
            
            fetchWithTimeout(API + '/api/product?barcode=' + encodeURIComponent(barcode))
              .then(r => {
                if (!r.ok) {
                  // If API returns error, still try to parse JSON for error message
                  return r.json().then(errData => {
                    // Return a not-found response instead of throwing
                    return { found: false, error: errData.error || 'Product not found' };
                  }).catch(() => {
                    // Return not-found if can't parse error
                    return { found: false, error: 'Product lookup failed' };
                  });
                }
                return r.json();
              })
              .then(data => {
                console.log('Product API response:', JSON.stringify(data, null, 2));
                console.log('Recyclability data:', {
                  recyclable: data.recyclable,
                  message: data.recyclabilityMessage,
                  confidence: data.recyclabilityConfidence
                });
                // Always show the modal - even if product not found, user can still proceed
                if (data && data.found !== false && data.name && data.name.trim() && data.name !== 'Unknown') {
                  // Product found with valid name - show it
                  const productData = {
                    name: data.name.trim(),
                    brand: (data.brand && data.brand.trim()) || 'Unknown',
                    category: (data.category && data.category.trim()) || 'Unknown',
                    image: data.image || null,
                    recyclable: data.recyclable !== undefined ? data.recyclable : null,
                    recyclabilityMessage: data.recyclabilityMessage || null,
                    recyclabilityConfidence: data.recyclabilityConfidence || 0
                  };
                  console.log('Showing product with name:', productData.name, 'recyclable:', productData.recyclable);
                  showProductModal(productData, barcode);
                  if (status) status.textContent = 'Confirm product to continue';
                } else if (data && data.found === true && data.name) {
                  // Product found but name might be empty - try to use brand
                  const productName = (data.name && data.name.trim() && data.name !== 'Unknown') 
                    ? data.name.trim() 
                    : ((data.brand && data.brand.trim()) ? data.brand.trim() : `Product (Barcode: ${barcode})`);
                  const productData = {
                    name: productName,
                    brand: (data.brand && data.brand.trim()) || 'Unknown',
                    category: (data.category && data.category.trim()) || 'Unknown',
                    image: data.image || null,
                    recyclable: data.recyclable !== undefined ? data.recyclable : null,
                    recyclabilityMessage: data.recyclabilityMessage || null,
                    recyclabilityConfidence: data.recyclabilityConfidence || 0
                  };
                  console.log('Showing product (fallback name):', productData.name, 'recyclable:', productData.recyclable);
                  showProductModal(productData, barcode);
                  if (status) status.textContent = 'Confirm product to continue';
                } else {
                  // Product not found or invalid - show modal with barcode
                  console.log('Product not found, showing fallback');
                  showProductModal({
                    name: `Product (Barcode: ${barcode})`,
                    brand: 'Unknown',
                    category: 'Unknown',
                    image: null,
                    recyclable: null,
                    recyclabilityMessage: null,
                    recyclabilityConfidence: 0
                  }, barcode);
                  if (status) status.textContent = 'Product not found. Confirm to continue.';
                }
              })
              .catch((err) => {
                console.error('Product lookup error:', err);
                // Show modal with barcode even on error - allow user to proceed
                // Silently handle the error - don't show alerts
                showProductModal({
                  name: `Product (Barcode: ${barcode})`,
                  brand: 'Unknown',
                  category: 'Unknown',
                  image: null,
                  recyclable: null,
                  recyclabilityMessage: null,
                  recyclabilityConfidence: 0
                }, barcode);
                if (status) status.textContent = 'Product details unavailable. Confirm to continue.';
              });
          } else if (currentStep === 'bin') {
            // Step 2: QR code scan for trash can
            // Extract can ID from QR code - could be just "TC001" or a URL like "/can/TC001"
            let canId = barcode;
            if (barcode.includes('/can/')) {
              // Extract from URL format
              const match = barcode.match(/\/can\/([^\/\s]+)/);
              if (match) canId = match[1];
            } else if (barcode.includes('canId=')) {
              // Extract from query param format
              const match = barcode.match(/canId=([^&\s]+)/);
              if (match) canId = decodeURIComponent(match[1]);
            }
            // Clean up the can ID
            canId = canId.trim();
            state.pendingBarcode = canId;
            
            if (status) status.textContent = 'Looking up trash can...';
            fetch(API + '/api/trash-cans/' + encodeURIComponent(canId))
              .then(r => {
                if (!r.ok && r.status === 404) {
                  // In demo mode, still allow it
                  if (status) status.textContent = 'Trash can not found, but continuing in demo mode...';
                  showTrashCanModal(canId, 'Unknown Trash Can', 'Unknown location', null);
                  return;
                }
                return r.json();
              })
              .then(data => {
                if (!data) return; // Already handled above
                const can = data.can || data;
                // Make sure we have the can ID (should be TC001, TC002, etc.)
                const finalCanId = can.id || canId;
                showTrashCanModal(finalCanId, can.label, can.location, can.image);
                if (status) status.textContent = 'Confirm trash can to continue';
              })
              .catch((err) => {
                console.error('Error fetching trash can:', err);
                // Still show modal even if can not found (for demo mode)
                showTrashCanModal(canId, 'Unknown Trash Can', 'Unknown location', null);
                if (status) status.textContent = 'Confirm trash can to continue';
              });
          }
        }
      }).catch(e => {
        state.isScanning = false;
        if (btn) btn.disabled = false;
        if (status) status.textContent = 'Camera error: ' + (e.message || 'Could not start');
      });
    }
    
    let videoTimerInterval = null;
    let videoStartTime = null;
    async function setupVideoRecording() {
      const recordVideo = document.getElementById('recordVideo');
      if (!recordVideo) return;
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
        recordVideo.srcObject = stream;
      } catch (err) {
        alert('Camera access denied: ' + err.message);
        cancelVideoRecording();
      }
    }
    function startVideoRecording() {
      const recordVideo = document.getElementById('recordVideo');
      if (!recordVideo || !recordVideo.srcObject) {
        alert('Camera not ready. Please wait a moment and try again.');
        return;
      }
      
      // Reset any previous recording state
      state.recordedChunks = [];
      state.isRecording = true;
      
      const startBtn = document.getElementById('startRecordBtn');
      const stopBtn = document.getElementById('stopRecordBtn');
      if (startBtn) {
        startBtn.style.display = 'none';
        startBtn.disabled = true;
      }
      if (stopBtn) {
        stopBtn.style.display = 'block';
        stopBtn.disabled = false;
        stopBtn.textContent = 'Stop & Submit';
      }
      
      const stream = recordVideo.srcObject;
      // Try different MIME types for better compatibility
      let mimeType = 'video/webm;codecs=vp8';
      if (!MediaRecorder.isTypeSupported(mimeType)) {
        mimeType = 'video/webm';
      }
      if (!MediaRecorder.isTypeSupported(mimeType)) {
        mimeType = 'video/mp4';
      }
      
      state.mediaRecorder = new MediaRecorder(stream, { 
        mimeType,
        videoBitsPerSecond: 2500000 // 2.5 Mbps for better quality
      });
      
      // Request data more frequently to ensure we capture all frames
      state.mediaRecorder.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) {
          console.log('Received video chunk:', e.data.size, 'bytes');
          state.recordedChunks.push(e.data);
        }
      };
      
      state.mediaRecorder.onerror = (e) => {
        console.error('MediaRecorder error:', e);
        alert('Recording error occurred. Please try again.');
        resetVideoRecordingState();
      };
      
      try {
        // Start recording and request data every 100ms to ensure we get all frames
        state.mediaRecorder.start(100);
        console.log('MediaRecorder started, recording...');
      } catch (err) {
        console.error('Error starting recorder:', err);
        alert('Failed to start recording: ' + err.message);
        resetVideoRecordingState();
        return;
      }
      
      videoStartTime = Date.now();
      const timerEl = document.getElementById('videoTimer');
      if (timerEl) timerEl.textContent = '0s';
      
      videoTimerInterval = setInterval(() => {
        const elapsed = Math.floor((Date.now() - videoStartTime) / 1000);
        if (timerEl) timerEl.textContent = elapsed + 's';
        if (elapsed >= 5) {
          stopVideoRecording();
        }
      }, 50); // Update more frequently for smoother timer
    }
    async function stopVideoRecording() {
      if (!state.mediaRecorder) return;
      if (state.mediaRecorder.state === 'inactive') return;
      
      const wasRecording = state.isRecording;
      state.isRecording = false;
      
      if (videoTimerInterval) {
        clearInterval(videoTimerInterval);
        videoTimerInterval = null;
      }
      
      const stopBtn = document.getElementById('stopRecordBtn');
      if (stopBtn) {
        stopBtn.disabled = true;
        stopBtn.textContent = 'Uploading...';
      }
      
      const status = document.getElementById('status');
      if (status) status.textContent = 'Uploading video for verification...';
      
      // Wait for recorder to stop and get the blob
      return new Promise((resolve) => {
        state.mediaRecorder.onstop = async () => {
          try {
            const blob = new Blob(state.recordedChunks, { type: 'video/webm' });
            await uploadVideoForVerification(blob);
            resolve();
          } catch (err) {
            console.error('Error in onstop:', err);
            resetVideoRecordingState();
            resolve();
          }
        };
        
        // Stop the recorder
        if (state.mediaRecorder.state !== 'inactive') {
          state.mediaRecorder.stop();
        }
        
        // Stop camera after a short delay
        setTimeout(() => {
          const recordVideo = document.getElementById('recordVideo');
          if (recordVideo && recordVideo.srcObject) {
            recordVideo.srcObject.getTracks().forEach(t => t.stop());
            recordVideo.srcObject = null;
          }
        }, 100);
      });
    }
    
    function resetVideoRecordingState() {
      // Reset all video recording state
      state.mediaRecorder = null;
      state.isRecording = false;
      state.recordedChunks = [];
      videoStartTime = null;
      if (videoTimerInterval) {
        clearInterval(videoTimerInterval);
        videoTimerInterval = null;
      }
      
      const startBtn = document.getElementById('startRecordBtn');
      const stopBtn = document.getElementById('stopRecordBtn');
      const timerEl = document.getElementById('videoTimer');
      
      if (startBtn) {
        startBtn.style.display = 'block';
        startBtn.disabled = false;
      }
      if (stopBtn) {
        stopBtn.style.display = 'none';
        stopBtn.disabled = false;
        stopBtn.textContent = 'Stop & Submit';
      }
      if (timerEl) timerEl.textContent = '0s';
      
      // Stop camera
      const recordVideo = document.getElementById('recordVideo');
      if (recordVideo && recordVideo.srcObject) {
        recordVideo.srcObject.getTracks().forEach(t => t.stop());
        recordVideo.srcObject = null;
      }
    }
    function cancelVideoRecording() {
      if (state.mediaRecorder && state.mediaRecorder.state !== 'inactive') {
        try {
          state.mediaRecorder.stop();
        } catch (e) {
          console.error('Error stopping recorder:', e);
        }
      }
      resetVideoRecordingState();
      state.recycleSession = null;
      state.recycleStep = null;
      state.pendingBarcode = null;
      document.getElementById('videoRecordModal').classList.remove('show');
      const status = document.getElementById('status');
      if (status) status.textContent = 'Ready to scan';
      updateScanSteps();
    }
    async function extractFramesFromVideo(videoBlob) {
      return new Promise((resolve, reject) => {
        console.log('Starting frame extraction, blob size:', videoBlob.size, 'type:', videoBlob.type);
        
        const video = document.createElement('video');
        const url = URL.createObjectURL(videoBlob);
        video.src = url;
        video.muted = true;
        video.playsInline = true;
        video.crossOrigin = 'anonymous';
        
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const frames = [];
        const frameCount = 3;
        let timeoutId = null;
        let isResolved = false;
        
        const cleanup = () => {
          if (timeoutId) clearTimeout(timeoutId);
          URL.revokeObjectURL(url);
        };
        
        const resolveOnce = (result) => {
          if (isResolved) return;
          isResolved = true;
          cleanup();
          resolve(result);
        };
        
        const rejectOnce = (error) => {
          if (isResolved) return;
          isResolved = true;
          cleanup();
          reject(error);
        };
        
        // Set timeout
        timeoutId = setTimeout(() => {
          if (frames.length > 0) {
            console.log(`Timeout but got ${frames.length} frames`);
            resolveOnce(frames);
          } else {
            rejectOnce(new Error('Frame extraction timeout'));
          }
        }, 15000);
        
        // Wait for video to be ready to play
        const extractFrames = async () => {
          try {
            // Wait a bit for video to fully load
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Play the video to ensure it's ready
            try {
              await video.play();
              // Pause immediately
              video.pause();
            } catch (playErr) {
              console.warn('Video play failed, continuing anyway:', playErr);
            }
            
            // Wait a bit more for video to be ready
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const width = video.videoWidth;
            const height = video.videoHeight;
            let duration = video.duration;
            
            console.log(`Video properties: ${width}x${height}, duration: ${duration}s`);
            
            // Validate dimensions
            if (!width || !height || width === 0 || height === 0 || isNaN(width) || isNaN(height)) {
              rejectOnce(new Error('Video has invalid dimensions'));
              return;
            }
            
            // Validate duration - if invalid, use a default or try to get it another way
            if (!duration || isNaN(duration) || !isFinite(duration) || duration <= 0) {
              console.warn('Video duration invalid, trying to get from metadata');
              // Try waiting a bit more
              await new Promise(resolve => setTimeout(resolve, 500));
              duration = video.duration;
              
              // If still invalid, use a default duration (5 seconds for our recording)
              if (!duration || isNaN(duration) || !isFinite(duration) || duration <= 0) {
                console.warn('Using default duration of 5 seconds');
                duration = 5.0;
              }
            }
            
            // Ensure duration is finite and positive
            duration = Math.max(0.5, Math.min(duration, 30)); // Clamp between 0.5s and 30s
            
            console.log(`Using duration: ${duration}s`);
            
            canvas.width = width;
            canvas.height = height;
            
            // Extract frames at different points in the video
            // Ensure times are valid numbers
            const times = [
              Math.max(0.1, Math.min(duration * 0.2, duration - 0.1)),  // 20% through
              Math.max(0.1, Math.min(duration * 0.5, duration - 0.1)),  // 50% through
              Math.max(0.1, Math.min(duration * 0.8, duration - 0.1))   // 80% through
            ].filter(t => isFinite(t) && t > 0 && t < duration);
            
            if (times.length === 0) {
              // Fallback: try to get frame at 0.5 seconds
              times.push(Math.min(0.5, duration - 0.1));
            }
            
            console.log(`Extracting frames at times: ${times.join(', ')}s`);
            
            let extracted = 0;
            
            const extractFrameAtTime = (time) => {
              return new Promise((frameResolve) => {
                // Validate time before using it
                if (!isFinite(time) || time < 0 || time >= duration) {
                  console.warn(`Invalid time ${time}, skipping`);
                  extracted++;
                  frameResolve();
                  return;
                }
                
                const seekHandler = () => {
                  video.removeEventListener('seeked', seekHandler);
                  try {
                    // Draw the current frame
                    ctx.drawImage(video, 0, 0, width, height);
                    const frameData = canvas.toDataURL('image/jpeg', 0.85);
                    
                    // Verify we got actual image data (not just black)
                    if (frameData && frameData.length > 5000) { // At least 5KB of data
                      frames.push(frameData);
                      console.log(`Extracted frame ${frames.length} at ${time.toFixed(2)}s`);
                    }
                    
                    extracted++;
                    frameResolve();
                  } catch (e) {
                    console.error('Error drawing frame:', e);
                    extracted++;
                    frameResolve();
                  }
                };
                
                const errorHandler = () => {
                  video.removeEventListener('seeked', seekHandler);
                  video.removeEventListener('error', errorHandler);
                  console.warn(`Failed to seek to ${time}s`);
                  extracted++;
                  frameResolve();
                };
                
                video.addEventListener('seeked', seekHandler, { once: true });
                video.addEventListener('error', errorHandler, { once: true });
                
                // Set currentTime with validation
                const safeTime = Math.max(0.1, Math.min(time, duration - 0.1));
                if (isFinite(safeTime) && safeTime > 0) {
                  video.currentTime = safeTime;
                } else {
                  console.warn(`Invalid time calculated: ${safeTime}, skipping`);
                  extracted++;
                  frameResolve();
                }
              });
            };
            
            // Extract all frames sequentially
            for (const time of times) {
              await extractFrameAtTime(time);
            }
            
            // If we didn't get enough frames, try getting a frame at the start
            if (frames.length === 0) {
              console.log('No frames extracted, trying frame at start');
              video.currentTime = 0.1;
              await new Promise(resolve => setTimeout(resolve, 500));
              try {
                ctx.drawImage(video, 0, 0, width, height);
                const frameData = canvas.toDataURL('image/jpeg', 0.85);
                if (frameData && frameData.length > 5000) {
                  frames.push(frameData);
                  console.log('Got frame at start');
                }
              } catch (e) {
                console.error('Error getting frame at start:', e);
              }
            }
            
            if (frames.length > 0) {
              console.log(`Successfully extracted ${frames.length} frames`);
              resolveOnce(frames);
            } else {
              rejectOnce(new Error('No valid frames extracted from video'));
            }
          } catch (err) {
            console.error('Error in extractFrames:', err);
            rejectOnce(new Error('Frame extraction failed: ' + err.message));
          }
        };
        
        // Wait for video to load metadata and be ready
        video.addEventListener('loadedmetadata', () => {
          console.log('Video metadata loaded');
        }, { once: true });
        
        video.addEventListener('loadeddata', () => {
          console.log('Video data loaded');
        }, { once: true });
        
        video.addEventListener('canplaythrough', () => {
          console.log('Video can play through');
          extractFrames().catch(rejectOnce);
        }, { once: true });
        
        video.addEventListener('error', (e) => {
          console.error('Video error:', e, video.error);
          const errorMsg = video.error 
            ? `Video error ${video.error.code}: ${video.error.message}` 
            : 'Video load error';
          rejectOnce(new Error(errorMsg));
        }, { once: true });
        
        // Start loading
        video.load();
      });
    }
    async function uploadVideoForVerification(videoBlob) {
      if (!state.recycleSession) {
        alert('Session expired. Please start over.');
        resetVideoRecordingState();
        document.getElementById('videoRecordModal').classList.remove('show');
        return;
      }
      
      const status = document.getElementById('status');
      const stopBtn = document.getElementById('stopRecordBtn');
      
      try {
        // Update status
        if (status) status.textContent = 'Extracting frames from video...';
        if (stopBtn) stopBtn.textContent = 'Processing...';
        
        // Extract frames with timeout
        let frames = [];
        try {
          const framesPromise = extractFramesFromVideo(videoBlob);
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Frame extraction timeout')), 20000)
          );
          frames = await Promise.race([framesPromise, timeoutPromise]);
          console.log(`Successfully extracted ${frames.length} frames from video`);
          
          if (!frames || frames.length === 0) {
            throw new Error('No frames extracted from video');
          }
          
          // Verify frames have actual content (not just black)
          const validFrames = frames.filter(frame => {
            // Check if frame is a valid data URL with reasonable size
            return frame && frame.startsWith('data:image') && frame.length > 10000;
          });
          
          if (validFrames.length === 0) {
            throw new Error('All extracted frames appear to be invalid or empty');
          }
          
          frames = validFrames;
          console.log(`Using ${frames.length} valid frames`);
        } catch (frameErr) {
          console.error('Frame extraction error:', frameErr);
          throw new Error('Could not extract valid frames from video: ' + frameErr.message);
        }
        
        if (status) status.textContent = 'Uploading video...';
        if (stopBtn) stopBtn.textContent = 'Uploading...';
        
        const formData = new FormData();
        formData.append('video', videoBlob, 'recycle-video.webm');
        formData.append('frames', JSON.stringify(frames));
        
        // Upload with timeout
        const uploadPromise = fetch(API + '/api/recycle/session/' + state.recycleSession + '/video', {
          method: 'POST',
          body: formData
        });
        const uploadTimeout = new Promise((_, reject) => 
          setTimeout(() => reject(new Error('Upload timeout')), 60000)
        );
        const res = await Promise.race([uploadPromise, uploadTimeout]);
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({ error: 'Upload failed' }));
          throw new Error(errorData.error || `Upload failed: ${res.status}`);
        }
        
        const data = await res.json();
        console.log('Verification response:', JSON.stringify(data, null, 2));
        
        // Make sure we have valid data
        if (!data || typeof data !== 'object') {
          throw new Error('Invalid response from server');
        }
        
        // Reset video recording state first
        resetVideoRecordingState();
        document.getElementById('videoRecordModal').classList.remove('show');
        
        // Reset recycle session state
        const sessionId = state.recycleSession;
        state.recycleSession = null;
        state.recycleStep = null;
        state.pendingBarcode = null;
        
        // ALWAYS show verification result - never skip this
        const verified = Boolean(data.verified);
        const pointsAwarded = Number(data.pointsAwarded || 0);
        const verdict = data.verdict || {};
        const confidence = Number(data.confidence || 0);
        
        console.log('Showing verification result:', { verified, pointsAwarded, confidence, verdict });
        
        if (verified && pointsAwarded > 0) {
          // Update points from server
          if (authState.user && authState.user.email) {
            try {
              const userRes = await fetch(API + '/api/user/' + encodeURIComponent(authState.user.email));
              const userData = await userRes.json();
              if (userData.user) {
                state.points = userData.user.points || 0;
                localStorage.setItem('cc_points', String(state.points));
                loadPoints();
              }
            } catch (e) {
              console.error('Error fetching user points:', e);
            }
          }
          if (status) status.textContent = `Verified! +${pointsAwarded} points earned!`;
          showVerificationResult(true, pointsAwarded, verdict, confidence);
        } else {
          if (status) status.textContent = 'Verification failed. Please try again.';
          const reason = verdict.notes || verdict.note || data.error || 'Video did not meet requirements. Make sure the item enters the trash can.';
          showVerificationResult(false, 0, verdict, confidence, reason);
        }
        
        updateScanSteps();
      } catch (err) {
        console.error('Upload error:', err);
        resetVideoRecordingState();
        document.getElementById('videoRecordModal').classList.remove('show');
        
        // ALWAYS show result modal even on error
        const errorMsg = err.message || 'Network error';
        showVerificationResult(false, 0, { pass: false, notes: errorMsg }, 0, errorMsg);
        
        state.recycleSession = null;
        state.recycleStep = null;
        if (status) status.textContent = 'Ready to scan';
        updateScanSteps();
      }
    }

    function showVerificationResult(verified, points, verdict, confidence, errorMsg) {
      const modal = document.getElementById('verificationResultModal');
      const title = document.getElementById('verificationResultTitle');
      const message = document.getElementById('verificationResultMessage');
      const details = document.getElementById('verificationResultDetails');
      
      console.log('Showing verification result modal:', { verified, points, confidence, verdict });
      
      if (verified) {
        if (title) {
          title.textContent = '‚úÖ Verification Successful!';
          title.style.color = '#041E42';
        }
        if (message) {
          message.innerHTML = `<strong style="font-size:18px; color:#3AAFA9;">You earned ${points} points!</strong><br><br>Your video was verified successfully.`;
        }
        if (details) {
          const conf = confidence ? (Math.round(confidence * 100) + '%') : 'N/A';
          const checks = verdict ? [
            verdict.bin_visible !== false ? '‚úì Bin visible' : '‚úó Bin not visible',
            verdict.bottle_visible !== false ? '‚úì Item visible' : '‚úó Item not visible',
            verdict.disposal_action !== false ? '‚úì Disposal action' : '‚úó No disposal action',
            verdict.item_enters_bin !== false ? '‚úì Item enters bin' : '‚úó Item does not enter bin'
          ].join('<br>') : 'All checks passed';
          details.innerHTML = `Confidence: ${conf}<br><br>Verification Checks:<br>${checks}`;
        }
      } else {
        if (title) {
          title.textContent = '‚ùå Verification Failed';
          title.style.color = '#dc2626';
        }
        if (message) {
          message.innerHTML = `<strong style="font-size:18px; color:#dc2626;">Verification failed</strong><br><br>${errorMsg || 'Video did not meet requirements.'}`;
        }
        if (details) {
          const conf = confidence ? (Math.round(confidence * 100) + '%') : '0%';
          const checks = verdict && typeof verdict === 'object' ? [
            verdict.bin_visible === true ? '‚úì Bin visible' : (verdict.bin_visible === false ? '‚úó Bin not visible' : '? Bin visibility unknown'),
            verdict.bottle_visible === true ? '‚úì Item visible' : (verdict.bottle_visible === false ? '‚úó Item not visible' : '? Item visibility unknown'),
            verdict.disposal_action === true ? '‚úì Disposal action' : (verdict.disposal_action === false ? '‚úó No disposal action' : '? Disposal action unknown'),
            verdict.item_enters_bin === true ? '‚úì Item enters bin' : (verdict.item_enters_bin === false ? '‚úó Item does not enter bin' : '? Item entry unknown')
          ].join('<br>') : 'Verification details unavailable';
          details.innerHTML = `Confidence: ${conf}<br><br>Verification Checks:<br>${checks}`;
        }
      }
      
      if (modal) {
        modal.classList.add('show');
        console.log('Verification result modal shown');
      } else {
        console.error('Verification result modal element not found!');
        // Fallback to alert if modal doesn't exist
        if (verified) {
          alert(`‚úÖ Verification Successful! You earned ${points} points.`);
        } else {
          alert(`‚ùå Verification Failed: ${errorMsg || 'Video did not meet requirements.'}`);
        }
      }
    }
    
    function closeVerificationModal() {
      document.getElementById('verificationResultModal').classList.remove('show');
    }

    // Seeded random number generator for deterministic randomness
    function seededRandom(seed) {
      let value = seed;
      return function() {
        value = (value * 9301 + 49297) % 233280;
        return value / 233280;
      };
    }

    // Generate network grid background with nodes and segments
    function generateNetworkGrid() {
      const container = document.getElementById('networkGridBg');
      if (!container) return;

      const seed = 12345; // Fixed seed for deterministic generation
      const rng = seededRandom(seed);
      
      // Generate ~140 nodes
      const nodeCount = 140;
      const nodes = [];
      for (let i = 0; i < nodeCount; i++) {
        const x = rng() * 100; // 0-100%
        const y = rng() * 100; // 0-100%
        const size = 1 + rng() * 1; // 1-2px
        const pulse = 1.6 + rng() * 1.0; // 1.6-2.6
        const duration = 2.5 + rng() * 5.5; // 2.5-8s
        const delay = rng() * 4; // 0-4s delay
        
        // 10% get accent colors
        const isAccent = rng() < 0.1;
        const accentType = rng() < 0.5 ? 'accent' : 'accent-mint';
        
        nodes.push({ x, y, size, pulse, duration, delay, isAccent, accentType });
      }

      // Generate ~60 connecting segments
      const segmentCount = 60;
      const segments = [];
      for (let i = 0; i < segmentCount; i++) {
        const x1 = rng() * 100;
        const y1 = rng() * 100;
        const isHorizontal = rng() < 0.5;
        const length = 20 + rng() * 40; // 20-60px
        const opacity = 0.08 + rng() * 0.07; // 0.08-0.15
        
        let x2, y2;
        if (isHorizontal) {
          x2 = x1 + length;
          y2 = y1;
        } else {
          x2 = x1;
          y2 = y1 + length;
        }
        
        segments.push({ x1, y1, x2, y2, opacity });
      }

      // Create node elements
      nodes.forEach(node => {
        const nodeEl = document.createElement('div');
        nodeEl.className = 'grid-node' + (node.isAccent ? ' ' + node.accentType : '');
        nodeEl.style.cssText = `
          top: ${node.y}%;
          left: ${node.x}%;
          width: ${node.size}px;
          height: ${node.size}px;
          --pulse: ${node.pulse};
          animation-duration: ${node.duration}s;
          animation-delay: ${node.delay}s;
        `;
        container.appendChild(nodeEl);
      });

      // Create segment elements
      segments.forEach(seg => {
        const segEl = document.createElement('div');
        segEl.className = 'grid-segment';
        const dx = seg.x2 - seg.x1;
        const dy = seg.y2 - seg.y1;
        const length = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
        
        segEl.style.cssText = `
          left: ${seg.x1}%;
          top: ${seg.y1}%;
          width: ${length}px;
          height: 1px;
          opacity: ${seg.opacity};
          transform: rotate(${angle}deg);
          transform-origin: 0 0;
        `;
        container.appendChild(segEl);
      });
    }

    // Initialize network grid on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', generateNetworkGrid);
    } else {
      generateNetworkGrid();
    }

    // Rewards data
    const rewardMilestones = [
      { points: 50, title: 'Free Coffee', label: 'Free Coffee' },
      { points: 100, title: 'Campus Store Discount', label: 'Store Discount' },
      { points: 200, title: 'Dining Raffle Entry', label: 'Raffle Entry' },
      { points: 350, title: 'Merch Drop', label: 'Merch Drop' },
      { points: 500, title: 'Sponsor Perk', label: 'Sponsor Perk' }
    ];
    
    const claimableRewards = [
      { id: 1, title: 'Free Coffee Coupon', costPoints: 50, description: 'Redeem for a free coffee at campus cafes.' },
      { id: 2, title: 'Campus Store Discount', costPoints: 100, description: 'Get 15% off at the Georgetown bookstore.' },
      { id: 3, title: 'Dining Credit Raffle Entry', costPoints: 200, description: 'Enter to win dining hall credits and meal swipes.' },
      { id: 4, title: 'Sustainable Merch Drop', costPoints: 350, description: 'Exclusive eco-friendly Georgetown merchandise.' },
      { id: 5, title: 'Priority Rewards / Sponsor Perk', costPoints: 500, description: 'Access to premium rewards and special sponsor benefits.' }
    ];
    
    function updateRewardsDashboard() {
      const points = state.points || 0;
      const maxMilestone = Math.max(...rewardMilestones.map(m => m.points));
      const progressPercent = Math.min(100, (points / maxMilestone) * 100);
      
      // Update reward track fill
      const trackFill = document.getElementById('rewardTrackFill');
      if (trackFill) trackFill.style.width = progressPercent + '%';
      
      // Render milestones
      const milestonesContainer = document.getElementById('rewardMilestones');
      if (milestonesContainer) {
        milestonesContainer.innerHTML = rewardMilestones.map(milestone => {
          const isCompleted = points >= milestone.points;
          return `
            <div class="reward-milestone">
              <div class="reward-milestone-node ${isCompleted ? 'completed' : 'upcoming'}"></div>
              <div class="reward-milestone-label">${milestone.label}</div>
              <div class="reward-milestone-points">${milestone.points} pts</div>
            </div>
          `;
        }).join('');
      }
      
      // Render claimable rewards
      const rewardsGrid = document.getElementById('claimRewardsGrid');
      if (rewardsGrid) {
        rewardsGrid.innerHTML = claimableRewards.map(reward => {
          const canClaim = points >= reward.costPoints;
          const pointsNeeded = reward.costPoints - points;
          return `
            <div class="claim-reward-card">
              <div class="claim-reward-header">
                <h4 class="claim-reward-title">${reward.title}</h4>
                <span class="claim-reward-cost">${reward.costPoints} pts</span>
              </div>
              <p class="claim-reward-desc">${reward.description}</p>
              <button type="button" class="claim-reward-btn ${canClaim ? 'enabled' : 'disabled'}" 
                onclick="handleClaimReward(${reward.id}, ${canClaim})" 
                ${!canClaim ? 'disabled' : ''}>
                ${canClaim ? 'Claim' : `Need ${pointsNeeded} more pts`}
              </button>
            </div>
          `;
        }).join('');
      }
    }
    
    function handleClaimReward(rewardId, canClaim) {
      if (!canClaim) return;
      const reward = claimableRewards.find(r => r.id === rewardId);
      if (reward) {
        // Check if user has enough points
        const currentPoints = state.points || 0;
        if (currentPoints < reward.costPoints) {
          alert(`Insufficient points. You need ${reward.costPoints} points to claim this reward.`);
          return;
        }
        
        // Subtract points
        const newPoints = currentPoints - reward.costPoints;
        state.points = newPoints;
        localStorage.setItem('cc_points', String(newPoints));
        
        // Refresh UI
        loadPoints();
        
        // Show confirmation
        alert(`Successfully claimed: ${reward.title}\nPoints remaining: ${newPoints}`);
      }
    }

    loadPoints();
    updateAuthUI();
  </script>
</body>
</html>
